$.widget('gene.inlineNotice', {
  _create: function () {
    this.$closeButtons = this.element.find('.cmp-inlinenotice__close-button');
    this.noticeId = this.element.data('id');
    this.cookieId = this.noticeId;
    this.mode = this.element.data('showmode');

    if (this.mode == 'cookie') {
      var cookie = GeneCore.utils.cookieUtils.getCookie(this.cookieId);
      if (cookie == null) {
        this.show();
      }
    } else if (this.mode == 'always' || this.mode == 'hideByDeeplink') {
      this.show();
    }

    this.$closeButtons.click(
      $.proxy(function (event) {
        event.preventDefault();
        this.hide();
      }, this)
    );
  },
  show: function (animate) {
    this.element.addClass('cmp-inlinenotice--open');
    if (animate) {
      this.element.slideDown({
        duration: 200,
        progress: $.proxy(this._animationStep, this),
      });
    } else {
      this.element.show();
      this._animationStep();
    }
  },
  hide: function () {
    this.element.removeClass('cmp-inlinenotice--open');
    this.element.slideUp({
      duration: 200,
      progress: $.proxy(this._animationStep, this),
    });

    if (this.mode == 'cookie') {
      var expirationDays = this.element.data('expiration-days');
      expriationDays = parseInt(expirationDays, 10);
      if (expirationDays < 1) {
        expirationDays = null;
      }
      GeneCore.utils.cookieUtils.setCookie(
        this.cookieId,
        'dismissed',
        expirationDays
      );
    }
  },
  deepLinkHandler: function () {
    if (this.mode == 'hideByDeeplink') {
      this.hide();
    } else {
      this.show();
    }
  },
  isNoticeShown: function () {
    return this.element.hasClass('cmp-inlinenotice--open');
  },
  _animationStep: function () {
    $(window).trigger('scroll');
  },
});

(function ($) {
  //Initialize Notice widgets
  $('.cmp-inlinenotice').inlineNotice();

  //Handle Notice link clicks
  $("a[href^='#notice']").click(function (e) {
    e.preventDefault();

    var anchorLinkHash = this.hash.substr(1);
    var noticeSelector = "[data-id='" + anchorLinkHash + "']";
    var $noticeElement = $(noticeSelector);

    $noticeElement.inlineNotice('show', true);
  });

  //Check for Notice deeplink or urlParameter
  var urlHash = GeneCore.utils.generalUtils.getUrlHash();
  if (urlHash && urlHash.startsWith('notice')) {
    noticeToShow = urlHash;
  } else {
    noticeToShow = GeneCore.utils.generalUtils.getUrlParam('notice');
  }

  if (noticeToShow) {
    var noticeSelector = "[data-id='" + noticeToShow + "']";
    var $deepLinkedNotice = $(noticeSelector);
    if ($deepLinkedNotice.length) {
      $deepLinkedNotice.inlineNotice('deepLinkHandler', false);
    }
  }
})(jQuery);

$.widget('gene.brightcovePlayer', {
  _create: function () {
    this.$transcriptLink = this.element.find(
      '.cmp-brightcoveplayer__transcript-link'
    );
    this.$transcriptLinkExpandText = this.$transcriptLink.data(
      'transcriptLinkExpandText'
    );
    this.$transcriptLinkCollapseText = this.$transcriptLink.data(
      'transcriptLinkCollapseText'
    );

    this.$transcriptContainer = this.element.find(
      '.cmp-brightcoveplayer__transcript-container'
    );
    this.isTranscriptVisible = false;

    this.element.closest('.cmp-modal').modal({
      hide: $.proxy(function (event, data) {
        var $containedPlayer = this.element.find('[data-playerid]');
        if ($containedPlayer.length) {
          var playerId = $containedPlayer.data('playerid');
          videojs.getPlayer(playerId).pause();
        }
      }, this),
    });

    this.$transcriptLink.click(
      $.proxy(function (event) {
        event.preventDefault();
        if (this.isTranscriptVisible) {
          this.$transcriptLink.removeClass('expanded');
          this.$transcriptLink.text(this.$transcriptLinkExpandText);
          this.$transcriptContainer.hide();

          $(window).trigger('scroll');
          this.isTranscriptVisible = false;
        } else {
          this.$transcriptLink.addClass('expanded');
          this.$transcriptLink.text(this.$transcriptLinkCollapseText);
          this.$transcriptContainer.show();

          $(window).trigger('scroll');
          this.isTranscriptVisible = true;
        }
      }, this)
    );
  },
  _animationStep: function () {
    $(window).trigger('scroll');
  },
});

$(function () {
  $('.cmp-brightcoveplayer').brightcovePlayer();
});

$.widget('gene.brightcovePlaylist', {
  _create: function () {
    this.$transcriptLinks = this.element.find(
      '.cmp-brightcoveplayer__transcript-link'
    );
    this.$videoMarquees = this.element.find('.cmp-brightcoveplayer__marquee');
    this.$thumbnails;
    this.bcPlayer;
    this.playlistId = this.element.find('video-js').attr('id');
    this.showAllPlaylistItems = this.element.data('showAllPlaylistItems');

    this.$videoMarquees.each(function (index) {
      this.$transcriptContainer = $(this).find(
        '.cmp-brightcoveplayer__transcript-container'
      );
      this.$transcriptLink = $(this).find(
        '.cmp-brightcoveplayer__transcript-link'
      );
    });

    var playerInitPromise = $.Deferred();
    var bcPlayer;
    videojs.getPlayer(this.playlistId).ready(function () {
      bcPlayer = this;
      playerInitPromise.resolve();
    });

    playerInitPromise.done(
      $.proxy(function () {
        this.bcPlayer = bcPlayer;
        this._initBcPlayer();
      }, this)
    );

    this.$transcriptLinks.click(
      $.proxy(function (event) {
        event.preventDefault();

        var $marquee = event.target.closest('.cmp-brightcoveplayer__marquee');
        var index = jQuery.inArray($marquee, this.$videoMarquees);
        $marquee = this.$videoMarquees[index];

        if ($marquee.$transcriptContainer.is(':visible')) {
          this._hideTranscript($marquee);
        } else {
          this._showTranscript($marquee);
        }
      }, this)
    );
  },

  _showTranscript: function ($marquee) {
    $marquee.$transcriptLink.text('Hide Transcript >');

    $marquee.$transcriptContainer.show();
    //We trigger scroll so safetybar/other components can update state if needed
    $(window).trigger('scroll');
  },

  _hideAllTranscripts: function () {
    this.$videoMarquees.each(function () {
      this.$transcriptLink.text('View Transcript >');
      this.$transcriptContainer.hide();
    });
  },

  _hideTranscript: function ($marquee) {
    $marquee.$transcriptLink.text('View Transcript >');

    $marquee.$transcriptContainer.hide();
    $(window).trigger('scroll');
  },

  _setMarqueeVisible: function (indexToShow) {
    this.$videoMarquees.each(function (index) {
      if (index == indexToShow) {
        $(this).show();
      } else {
        $(this).hide();
      }
    });
  },

  _initBcPlayer: function () {
    this.bcPlayer.on(
      'loadedmetadata',
      $.proxy(function () {
        console.log(
          'playing video index: ' + this.bcPlayer.playlist.currentIndex()
        );
        this._setMarqueeVisible(this.bcPlayer.playlist.currentIndex());

        this.$thumbnails = this.element.find('.vjs-playlist-item');

        this.$thumbnails.click(
          $.proxy(function (event) {
            GeneCore.utils.anchorsUtil.scrollToYPosition(
              this.element.offset().top,
              true
            );
          }, this)
        );

        this._hideAllTranscripts();

        if (this.showAllPlaylistItems) {
          if (GeneCore.utils.resizeUtil.getCurrentBreakpoint() != 'xs') {
            this._adjustPlaylistPlayerHeight();
          }
          $(window).on(
            'breakpoint-change',
            _.throttle($.proxy(this._handlePlaylistHeight, this), 50)
          );
        }
      }, this)
    );

    this.bcPlayer.on(
      'duringplaylistchange',
      $.proxy(function () {}, this)
    );
  },

  _animationStep: function () {
    $(window).trigger('scroll');
  },

  _handlePlaylistHeight: function (e, breakpoint) {
    if (breakpoint != 'xs') {
      this._adjustPlaylistPlayerHeight();
    } else {
      this.element
        .find('.vjs-playlist-player-container')
        .css('min-height', 'auto');
    }
  },

  _adjustPlaylistPlayerHeight: function () {
    var height = this.element.find('.vjs-playlist-item-list').outerHeight();
    this.element
      .find('.vjs-playlist-player-container')
      .css('min-height', height + 'px');
  },
});

(function ($) {
  $('.cmp-brightcoveplaylist').brightcovePlaylist();

  var deeplinkId = GeneCore.utils.generalUtils.getUrlParam('playlistVideoId');
  if (deeplinkId) {
    var $container = $("[data-video-id='" + deeplinkId + "']").closest(
      '.cmp-brightcoveplaylist'
    );
    GeneCore.utils.anchorsUtil.scrollToYPosition($container.offset().top, true);
  }
})(jQuery);

// Mobile
$.widget('gene.conditionPickerMenu', {
  _create: function () {
    //this.element and this.options are available here

    this.selectedCondition = this.element.data('selectedCondition');

    if (this.selectedCondition !== undefined) {
      this.$buttonText = this.element
        .find('.cmp-condition-picker__mobile-menu__toggle-control__text')
        .text(this.selectedCondition);
    }

    this.$toggleControl = this.element.find(
      '.cmp-condition-picker__mobile-menu__toggle-control'
    );

    this.$toggleControl.on('click', $.proxy(this.toggleMenu, this));
  },

  toggleMenu: function () {
    this.element
      .find('.cmp-condition-picker__mobile-menu__items')
      .slideToggle('fast');
    this.$toggleControl.toggleClass(
      'cmp-condition-picker__mobile-menu__toggle-control--open'
    );
  },
});

(function ($) {
  //Initialize Condition Picker Mobile  widgets
  $('.cmp-condition-picker__mobile-menu').conditionPickerMenu();
})(jQuery);

// Desktop
$.widget('gene.conditionPicker', {
  _create: function () {
    this.isMastheadSticky = $('.cmp-masthead').hasClass('sticky');
  },

  toggleMenu: function () {
    this.element.slideToggle({
      duration: 200,
      progress: $.proxy(this._animationStep, this),
    });
  },

  _animationStep: function () {
    if (this.isMastheadSticky) {
      $('.cmp-masthead').stickyNav('stickyToggle');
    }
  },
});

(function ($) {
  //Initialize Condition Picker widget
  $('.cmp-condition-picker__content').conditionPicker();
})(jQuery);

$.widget('gene.conditionPickerSelector', {
  _create: function () {
    this.selectedCondition = this.element.data('selectedCondition');

    if (this.selectedCondition !== undefined) {
      this.$buttonText = this.element
        .find('.cmp-condition-picker__button__text')
        .text(this.selectedCondition);
    }

    this.element.on('click', $.proxy(this.toggleMenu, this));
  },

  toggleMenu: function () {
    $('.cmp-condition-picker__content').conditionPicker('toggleMenu');

    if (this.element.hasClass('cmp-condition-picker__button--open')) {
      this.element.removeClass('cmp-condition-picker__button--open');
      $(document).off('mouseup.navItem');
    } else {
      this.element.addClass('cmp-condition-picker__button--open');

      var _this = this;
      var $container = $('.cmp-condition-picker__content');

      $(document).on('mouseup.navItem', function (e) {
        if (
          !_this.element.is(e.target) && // if the target of the click isn't the container...
          _this.element.has(e.target).length === 0 && // ... nor a descendant of the container
          !$container.is(e.target) && // if the target of the click isn't the content container...
          $container.has(e.target).length === 0
        ) {
          // ... nor a descendant of the content container
          $container.conditionPicker('toggleMenu');
          _this.element.removeClass('cmp-condition-picker__button--open');

          $(document).off('mouseup.navItem');
        }
      });
    }
  },
});

(function ($) {
  //Initialize Condition Picker  widgets
  $('.cmp-condition-picker__button').conditionPickerSelector();
})(jQuery);

$.widget('gene.table', {
  _create: function () {
    //this.element and this.options are available here

    this.stackedOnMobile = this.element
      .parents('.cmp-text')
      .data('tableStackedOnMobile');
    this.lockFirstColumn = this.element
      .parents('.cmp-text')
      .data('tableLockFirstColumn');

    // Add table class and wrappers
    this.element.addClass('cmp-text__table');
    this.element.wrap('<div class="table-scroller"></div>');
    this.element
      .parent()
      .wrap('<div class="cmp-text__table--scrollable"></div>');

    this.$tableOuterWrapper = this.element.parents(
      '.cmp-text__table--scrollable'
    );
    this.$tableWrapper = this.element.parents('.table-scroller');
    this.isTableOverflowing = false;

    // Add listener to scroll event and resize
    this.$tableWrapper.on(
      'scroll',
      _.throttle($.proxy(this._checkTableScroll, this), 50)
    );
    $(window).on(
      'resize',
      _.throttle($.proxy(this._checkTableScroll, this), 50)
    );

    $(window).on(
      'breakpoint-change',
      _.throttle($.proxy(this._breakpointChangeHandler, this), 50)
    );

    if (this.lockFirstColumn) {
      // Add modifier to lock the first column
      this.$tableOuterWrapper.addClass('cmp-text__table--column-locked');
    }

    // Initialize table.
    this._initializeTable();

    this._checkTableScroll();
  },

  _initializeTable: function () {
    var $row = this.element.find('tr:first');

    var $dataColumns = $row.find('td');

    if ($dataColumns.length == 0) {
      var $headerColumns = $row.find('th');

      this.element.prepend('<thead>' + $row.html() + '</thead>');

      var headers = [];

      $row.find('th').each(function (index, header) {
        if (index > 0) {
          headers.push($(header).html());
        }
      });

      $row.remove();

      if (headers.length > 0) {
        this.element.find('tbody tr').each(function () {
          var $cols = $(this).find('td, th');
          $cols.each(function (index, element) {
            if (index > 0) {
              $(element).attr('data-header', headers[index - 1]);
            }
          });
        });
      }

      if (this.stackedOnMobile) {
        // Add modifier to stack the rows on mobile
        this.$tableOuterWrapper.addClass('cmp-text__table--stacked');
      }
    }

    if (this.lockFirstColumn) {
      this.element.find('tr th:first').each(function () {
        $(this).addClass('sticky-col');
        var rowHeight = $(this).parents('tr').height();
        $(this).css('height', rowHeight);
      });

      this.element.find('tbody th').each(function () {
        $(this).addClass('sticky-col');
        var rowHeight = $(this).parents('tr').height();
        $(this).css('height', rowHeight);
      });
    }

    this.element.attr('border', 0); //This is to avoid border issues in IE
  },

  _breakpointChangeHandler: function (e, breakpoint) {
    if (breakpoint == 'xs' && this.stackedOnMobile && this.lockFirstColumn) {
      this.element.find('tr th:first').each(function () {
        $(this).removeClass('sticky-col');
        $(this).css('height', 'auto');
      });

      this.element.find('tbody th').each(function () {
        $(this).removeClass('sticky-col');
        $(this).css('height', 'auto');
      });

      this.element.parents('.table-scroller').css('margin-left', 0);
    } else {
      if (breakpoint != 'xs' && this.stackedOnMobile && this.lockFirstColumn) {
        this.element.find('tr th:first').each(function () {
          $(this).addClass('sticky-col');
          var rowHeight = $(this).parents('tr').height();
          $(this).css('height', rowHeight);
        });

        this.element.find('tbody th').each(function () {
          $(this).addClass('sticky-col');
          var rowHeight = $(this).parents('tr').height();
          $(this).css('height', rowHeight);
        });
        this.element.parents('.table-scroller').css('margin-left', '120px');
      }
    }
  },

  _checkTableScroll: function () {
    if (
      this.$tableWrapper[0].scrollWidth > this.$tableOuterWrapper.innerWidth()
    ) {
      this.isTableOverflowing = true;

      if (
        this.$tableWrapper[0].scrollWidth - this.$tableWrapper.scrollLeft() ==
        this.$tableWrapper.outerWidth()
      ) {
        this.$tableWrapper.removeClass('table-scroller--right');
      } else {
        this.$tableWrapper.addClass('table-scroller--right');
      }

      if (this.$tableWrapper.scrollLeft() === 0) {
        this.$tableWrapper.removeClass('table-scroller--left');
      } else {
        this.$tableWrapper.addClass('table-scroller--left');
      }
    } else {
      this.isTableOverflowing = false;

      this.$tableWrapper.removeClass(
        'table-scroller--left table-scroller--right'
      );
    }
  },
});

(function ($) {
  //Initialize Table widgets
  $('.cmp-text table').table();
})(jQuery);

var observerTable = new MutationSummary({
  callback: function (changes) {
    changes.forEach(function (change) {
      change.added.forEach(function (el) {
        if ($(el).parents('.cmp-text').length > 0) {
          $(el).table();
        }
      });
    });
  },
  queries: [{ element: 'table' }],
  rootNode: document.getElementsByClassName('basicpage')[0],
});

$.widget('gene.tabs', {
  vars: {
    leftScrollClass: 'cmp-tabs__scroll-outer--left',
    rightScrollClass: 'cmp-tabs__scroll-outer--right',
    animationTimeMs: 400,
  },
  _create: function () {
    this.$standardTabButtons = this.element.find(
      '.cmp-tabs--standard .cmp-tabs__tab'
    );
    this.$tabContentContainers = this.element.find('.cmp-tabs__container');

    this.$accordion = this.element.find('.cmp-tabs--accordion');
    this.$accordionTabButtons = this.element.find(
      '.cmp-tabs__button--accordion'
    );

    this.$allTabButtons = this.element.find('.cmp-tabs__item');
    this.$allTabContainers = this.element.find('.cmp-tabs__container');

    this.$tabsWrapper = this.element.find('.cmp-tabs__wrapper');
    this.$tabsScrollOuter = this.element.find('.cmp-tabs__scroll-outer');
    this.isTabsOverflowing = false;

    //Bind window events and set scroll shadows (if needed)
    this.$tabsWrapper.on(
      'scroll',
      _.throttle($.proxy(this._checkTabScroll, this), 50)
    );
    $(window).on('resize', _.throttle($.proxy(this._checkTabScroll, this), 50));

    this._checkTabScroll();

    // Display first child element
    this.$tabContentContainers.first().show();

    // Bind click events
    this.$standardTabButtons.on('click', $.proxy(this._handleTabClick, this));
    this.$accordionTabButtons.on('click', $.proxy(this._handleTabClick, this));
  },
  openTabLink: function (tabId, disableSmoothScroll, deeplink) {
    var $tabToOpen = this.$allTabButtons.filter(
      "[data-tab-target='" + tabId + "']:visible"
    );
    this._setTabActive($tabToOpen, true, disableSmoothScroll, deeplink);
  },
  _handleTabClick: function (e) {
    e.preventDefault();
    var $clickedTab = $(e.target).closest('.cmp-tabs__item');
    this._setTabActive($clickedTab, false);
  },
  _setTabActive: function ($tab, isDeepLink, disableSmoothScroll, deeplink) {
    var isAccordionClick = $tab.hasClass('cmp-tabs__button--accordion');
    var isAlreadyActive = $tab.hasClass('cmp-tabs__item--active');

    var targetTabId = $tab.data('tab-target');
    var $tabContentToShow = this.$tabContentContainers.filter(
      "[data-tab-id='" + targetTabId + "']"
    );

    if (!isAlreadyActive) {
      //update other tabs as closed in analytics
      let that = this;
      this.$allTabButtons.filter('.cmp-tabs__item--active').each(function () {
        that._updateDataAnalytics('state', 'tab-closed', this);
      });
      this.$allTabButtons.removeClass('cmp-tabs__item--active');
      this.$tabContentContainers.hide();
      this.$allTabButtons
        .filter("[data-tab-target='" + targetTabId + "']")
        .addClass('cmp-tabs__item--active');

      //update clicked tab as opened in analytics
      this._updateDataAnalytics('state', 'tab-open', $tab[0]);

      if (isDeepLink || !isAccordionClick) {
        $tabContentToShow.fadeIn();
      } else {
        $tabContentToShow.slideDown(this.vars.animationTimeMs);
        GeneCore.utils.anchorsUtil.scrollToYPosition($tab.offset().top, false);
      }

      if (this.isTabsOverflowing) {
        this.$tabsWrapper.animate(
          {
            scrollLeft: $tab.position().left - 50,
          },
          this.vars.animationTimeMs,
          'swing'
        );
      }
    } else if (isAccordionClick && !isDeepLink) {
      $tab.removeClass('cmp-tabs__item--active');
      $tabContentToShow.slideUp(this.vars.animationTimeMs);
    }

    if (isDeepLink) {
      if (deeplink) {
        GeneCore.utils.anchorsUtil.scrollToYPosition(
          $('#' + deeplink).offset().top,
          disableSmoothScroll
        );
      } else {
        GeneCore.utils.anchorsUtil.scrollToYPosition(
          $tab.offset().top,
          disableSmoothScroll
        );
      }
    }
  },
  _checkTabScroll: function () {
    if (this.$tabsWrapper[0].scrollWidth > this.$tabsScrollOuter.innerWidth()) {
      this.isTabsOverflowing = true;

      if (
        this.$tabsWrapper[0].scrollWidth - this.$tabsWrapper.scrollLeft() ==
        this.$tabsWrapper.outerWidth()
      ) {
        this.$tabsScrollOuter.removeClass(this.vars.rightScrollClass);
      } else {
        this.$tabsScrollOuter.addClass(this.vars.rightScrollClass);
      }

      if (this.$tabsWrapper.scrollLeft() === 0) {
        this.$tabsScrollOuter.removeClass(this.vars.leftScrollClass);
      } else {
        this.$tabsScrollOuter.addClass(this.vars.leftScrollClass);
      }
    } else {
      this.isTabsOverflowing = false;

      this.$tabsScrollOuter.removeClass(
        this.vars.leftScrollClass + ' ' + this.vars.rightScrollClass
      );
    }
  },

  _updateDataAnalytics: function (propertyName, propertyValue, element) {
    if (element.dataset.analytics) {
      let analytics = JSON.parse(
        JSON.parse('"' + element.dataset.analytics + '"')
      );
      analytics[propertyName] = propertyValue;
      element.setAttribute(
        'data-analytics',
        JSON.stringify(analytics).replace(/"/g, '\\"')
      );
    }
  },
});

(function ($) {
  $('.cmp-tabs').tabs();

  //Handle tab link clicks in page content
  $("a[href^='#tab']").click(function (e) {
    e.preventDefault();

    var tabsLinkHash = this.hash.substr(1);
    var tabsSelector = "[data-tab-id='" + tabsLinkHash + "']";
    var $tabsElement = $(tabsSelector).closest('.cmp-tabs');

    $tabsElement.tabs('openTabLink', tabsLinkHash, false);
  });

  //Check for tab deeplink
  var urlHash = GeneCore.utils.generalUtils.getUrlHash();
  if (urlHash && urlHash.startsWith('tab')) {
    var deeplinks = urlHash.split('$$');
    var tabsSelector = "[data-tab-id='" + deeplinks[0] + "']";
    var $tabsElement = $(tabsSelector).closest('.cmp-tabs');

    //deeplinks[0] = tabId
    //deeplinks[1] = Deep Link inside the tab
    $tabsElement.tabs(
      'openTabLink',
      deeplinks[0],
      true,
      deeplinks[1] ? deeplinks[1] : null
    );
  }
})(jQuery);

$.widget('gene.modal', {
  vars: {
    focusedElementBeforeModal: null,
    openModals: [],
  },

  _create: function () {
    var _this = this;
    this.vars.focusedElementBeforeModal = jQuery(':focus');
    this.isEditMode = this.element.hasClass('edit-mode');
    this.$closeButtons = this.element.find('.cmp-modal__close');
    this._initInternalAnchors();
    this._appendAriaLevelToModal();

    this.$confirmButton = this.element.find('.cmp-modal__button--confirm');

    if (
      !this.isEditMode &&
      this.options.showOnPageLoad &&
      GeneCore.utils.cookieUtils.getCookie(this.options.modalId) == null
    ) {
      if ($('.safetybar').length) {
        $(window).on(
          'safetybar:ready',
          $.proxy(function () {
            this.show();
          }, this)
        );
      } else {
        this.show();
      }
    }
    this._initCloseActions();
  },

  _initCloseActions: function () {
    this.$confirmButton.click(
      $.proxy(function (event) {
        this.hide();
      }, this)
    );

    this.$closeButtons.click(
      $.proxy(function (event) {
        event.preventDefault();
        this.hide();
      }, this)
    );
  },

  _initInternalAnchors: function () {
    var _modal = this;
    this.element.find('a').each(function () {
      $this = $(this);
      var href = $this.attr('href');

      if (href && href.startsWith('#') && href !== '#') {
        var _scrollTargetElem = _modal.element.find(href);
        if (_scrollTargetElem.length) {
          _modal.element.css('scroll-behavior', 'smooth');
          _modal._addModalScroll($this, _scrollTargetElem);
        }
      }
    });
  },

  _appendAriaLevelToModal: function () {
    let headingElement = this.element
      .find('.cmp-modal__heading')
      .find(':header');
    if (headingElement.length > 0) {
      let headingLevel = new RegExp('H(\\d)').exec(
        headingElement[0].nodeName
      )[1];
      if (headingElement.length > 0 && $.isNumeric(headingLevel)) {
        this.element
          .find('.cmp-modal__heading')
          .attr('aria-level', headingLevel);
      }
    }
  },

  _addModalScroll: function (hrefElem, scrollTargetElem) {
    var params = {
      scrollTargetElem: scrollTargetElem,
      modal: $(this),
    };

    //unbind any other click event attached add apply the skip-anchor class to prevent add achor click events.
    hrefElem.unbind('click');
    hrefElem.addClass('skip-anchor');
    hrefElem.removeAttr('href');

    hrefElem.click(
      $.proxy(function (e) {
        this.scrollTargetElem[0].scrollIntoView();
      }, params)
    );
  },

  show: function () {
    var _this = this;

    this._setOverflow(true);

    this.element.addClass('modal-shown').queue(
      $.proxy(function () {
        this.element.addClass('modal-fade').dequeue();
        this._focusFirstItem();
      }, this)
    );

    this.vars.openModals.push(this);

    if (this.vars.openModals.length === 1) {
      //handle escape button.
      $(document).on('keyup.modal', function (e) {
        if (e.key === 'Escape') {
          //Check what was the latest modal open and close it
          if (_this.vars.openModals.length) {
            var lastModal =
              _this.vars.openModals[_this.vars.openModals.length - 1];
            if (
              !lastModal.options.forceUserDecisions &&
              _this.checkIsOnFront(lastModal.element)
            ) {
              lastModal.element.modal('hide');
            }
          }
        }
      });
    }
    $(window).trigger('modal:show');
  },

  checkIsOnFront: function (elem) {
    var frontElement = document.elementFromPoint(
      $(window).width() / 2,
      $(window).height() / 2
    );
    if (elem.is(frontElement.closest('.cmp-modal'))) {
      return true;
    }
    return false;
  },

  hide: function () {
    this._setOverflow(false);

    this.vars.openModals.pop(this);
    if (this.vars.openModals.length === 0) {
      $(document).off('keyup.modal');
    }

    if (!this.options.saveLatestScroll) {
      this.element.find('.cmp-modal__body').scrollTop(0);
    }
    $(document).off('click.modal');
    this.element.removeClass('modal-fade').queue(
      $.proxy(function () {
        this.element.removeClass('modal-shown').dequeue();
      }, this)
    );

    if (this.vars.focusedElementBeforeModal) {
      this.vars.focusedElementBeforeModal.focus();
    }

    if (this.options.showOnPageLoad) {
      var expirationDays = this.options.daysUntilNextTrigger;
      expriationDays = parseInt(expirationDays);

      if (expirationDays > 0) {
        GeneCore.utils.cookieUtils.setCookie(
          this.options.modalId,
          'dismissed',
          expirationDays
        );
      } else {
        GeneCore.utils.cookieUtils.deleteCookie(this.options.modalId);
      }
    }

    $(window).trigger('modal:hide');
  },

  _setOverflow: function (active) {
    if (active) {
      var scrollWidth = window.innerWidth - $(document).width();
      $('body').addClass('body-modal-active');
      $('html').css('padding-right', scrollWidth);
    } else {
      $('body').removeClass('body-modal-active');
      $('html').css('padding-right', '');
    }
  },

  _focusFirstItem: function () {
    var focusableElementsString =
      'a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, object, embed, *[tabindex], *[contenteditable]';
    var o = this.element.find('*');
    var focusableItems = o.filter(focusableElementsString);
    focusableItems.first().focus();
  },
});

(function ($) {
  //Init modal widgets
  $('.cmp-modal')
    .each(function () {
      var dataOptions = $(this).data();

      // Set default values for modal options.
      // forceUserDecisions: false
      // showOnPageLoad: false
      // daysUntilNextTrigger: -1
      var options = {
        forceUserDecisions:
          dataOptions.forceUserDecisions !== undefined
            ? dataOptions.forceUserDecisions
            : false,
        showOnPageLoad:
          dataOptions.showOnPageLoad !== undefined
            ? dataOptions.showOnPageLoad
            : false,
        daysUntilNextTrigger:
          dataOptions.daysUntilNextTrigger !== undefined &&
          dataOptions.daysUntilNextTrigger >= 0
            ? dataOptions.daysUntilNextTrigger
            : -1,
        modalId: dataOptions.modalId,
        saveLatestScroll: dataOptions.saveLatestScroll,
      };

      $(this).modal(options);
    })
    .modal();

  //Handle modal link clicks
  $("a[href^='#modal']").click(function (e) {
    e.preventDefault();
    e.stopPropagation();

    var anchorLinkHash = this.hash.substr(1);
    var modalSelector = '.' + anchorLinkHash;
    var $modalElement = $(modalSelector);

    $modalElement.modal('show');
  });

  //Check for modal deeplink
  var urlHash = GeneCore.utils.generalUtils.getUrlHash();
  if (urlHash && urlHash.startsWith('modal')) {
    var modalSelector = '.' + urlHash + '.cmp-modal';
    var $deepLinkedModal = $(modalSelector);
    if ($deepLinkedModal.length) {
      $deepLinkedModal.modal('show');
    }
  }

  /*
  =====================================================================
  External HCP Modal
  =====================================================================
  */
  var hcpLinks;
  function initHcpPopups() {
    var isHcp = false,
      thisPageHref = window.location.href,
      thisPagePath = window.location.pathname,
      hcpUrls = window.hcpUrls,
      newURLs = [],
      tempURL,
      href,
      target,
      $hcpModal = $('.hcp-modal.exit-modal .cmp-modal');

    //This forces a boolean result, nearly functionally equates to if(geneUrls === true)
    if (!!hcpUrls) {
      // This for block loops through all hcpurls and creates both a http and https stored in newURLs array
      for (var i = 0; i < hcpUrls.length; i++) {
        tempURL = hcpUrls[i].replace('http://', 'https://');
        newURLs.push(tempURL);
        tempURL = hcpUrls[i].replace('https://', 'http://');
        newURLs.push(tempURL);
      }

      // For each item in our newURLs array, see if the current page or path we are on matches.
      // If so, we are on an hcp page and don't want to display the modal
      // Then assemble a string of "links" from our newURLs array
      for (var i = 0; i < newURLs.length; i++) {
        if (
          thisPageHref.indexOf(newURLs[i]) > -1 ||
          thisPagePath.indexOf(newURLs[i]) > -1
        ) {
          isHcp = true;
        }
        hcpLinks += 'a[href*="' + newURLs[i] + '"],';
      }
      // Regex out commas and whitespaces from string
      hcpLinks = hcpLinks.replace(/,\s*$/, '');

      // If we are NOT on an HCP page and click a matching link found in
      // hcplinks string
      if (!isHcp && $hcpModal.length) {
        $(hcpLinks).on('click', function (e) {
          e.preventDefault();
          e.stopPropagation();

          href = $(this).attr('href');
          target = $(this).attr('target') || '_self';

          // Checks if the user wants to open the link in a new tab
          if (
            e.ctrlKey ||
            e.shiftKey ||
            e.metaKey || // apple
            (e.button && e.button == 1) // middle click, >IE9 + everyone else
          ) {
            target = '_blank';
          }

          $hcpModal
            .find('.cmp-modal__button--confirm')
            .attr({ href: href, target: target });
          $hcpModal.modal('show');
        });
      }
    }
  }

  /*
  =====================================================================
  External / 3rd Party Modal
  =====================================================================
  */
  // function initExitModals() {
  //   var noExternal = '[data-link-third-party], ',
  //     href,
  //     target,
  //     newURLs = [],
  //     tempURL,
  //     allowedExternalUrls = window.allowedExternalUrls || [],
  //     $exitModal = $('.third-part-modal.exit-modal .cmp-modal'),
  //     defaults = [
  //       'http://gene.com',
  //       'http://www.gene.com',
  //       'http://racopay.com',
  //       'http://www.racopay.com',
  //       'http://genentech-access.com',
  //       'http://www.genentech-access.com'
  //     ];

  //   // This forces a boolean result, nearly functionally equates to if(geneUrls === true)
  //   // Should always pass since we've hardcoded defaults above
  //   if (!!window.allowedExternalUrls || defaults.length >= 0) {

  //     // This for block loops through all geneUrls and creates both a http and https stored in newURLs array
  //     for (var i = 0; i < allowedExternalUrls.length; i++) {
  //       tempURL = allowedExternalUrls[i].replace("http://", "https://");
  //       newURLs.push(tempURL);
  //       tempURL = allowedExternalUrls[i].replace("https://", "http://");
  //       newURLs.push(tempURL);
  //     }
  //     // Do the same for defaults
  //     for (i = 0; i < defaults.length; i++) {
  //       tempUrl = defaults[i].replace("http://", "https://");
  //       newURLs.push(tempUrl);
  //     }
  //     // Adds defaults to geneUrls array
  //     newURLs = newURLs.concat(defaults);

  //     // Assemble a string of "links" from our newURLs array
  //     for (var i = 0; i < newURLs.length; i++) {
  //       noExternal += 'a[href*="' + newURLs[i] + '"],';
  //     }
  //     // Regex out commas and whitespaces from string
  //     noExternal = noExternal.replace(/,\s*$/, "");

  //       // By definition, hcp links are gene controlled so add them to our list
  //       if (noExternal && hcpLinks) {
  //         noExternal = noExternal + ',' + hcpLinks;
  //       }
  //   }

  //   $('a[href^="http"]').not(noExternal).addClass('external-link-indicator');

  //   // Click handlers for links on the page
  //   $('a[href^="http"]').not(noExternal).on('click', function(e) {
  //     e.preventDefault();
  //     e.stopPropagation();

  //     href = $(this).attr('href');
  //     target = $(this).attr('target') || '_self';

  //     // Checks if the user wants to open the link in a new tab
  //     if ( e.ctrlKey || e.shiftKey || e.metaKey || // apple
  //       (e.button && e.button == 1) // middle click, >IE9 + everyone else
  //     ) {
  //       target = '_blank'
  //     }

  //     $exitModal.find('.cmp-modal__button--confirm').attr({"href": href, "target": target});
  //     $exitModal.modal('show');
  //   });
  // }

  initHcpPopups();
  initExitModals();
})(jQuery);

$.widget('gene.safetyBar', {
  _create: function () {
    this.$stickyWrapper = this.element.find('.cmp-safetybar__sticky-wrapper');
    this.$header = this.element.find('.cmp-safetybar__header');
    this.$spotlightContent = this.element.find('.cmp-safetybar__inner-wrapper');
    this.$buttonBackToTop = this.element.find('.cmp-safetybar__button-top');
    this.$buttonSeeMore = this.element.find('.cmp-safetybar__button-see-more');
    this.$buttonMinimize = this.element.find('.cmp-safetybar__button-minimize');

    this.isAnimationDisabled = this.element
      .get(0)
      .hasAttribute('data-disable-animation');
    this.smallDeviceHeight = this.element.data('small-height') || 150;
    this.mediumDeviceHeight = this.element.data('medium-height') || 150;
    this.isSticky = false;
    this.stickyHeight = 150;
    this.isMinimized = false;
    this.minimizedCookieId = 'safety-bar-is-minimized';
    this.spotlightContentHeight;
    this.smallMediaQuery = window.matchMedia('(max-width: 750px)');
    this.isReady = false;

    if (this.$buttonMinimize.length) {
      this._checkMinimizedState();
    }

    // Bind events
    $(window).on(
      'resize',
      _.throttle(
        $.proxy(function () {
          this._checkPosition(true);
        }, this),
        50
      )
    );

    $(window).on('scroll', _.throttle($.proxy(this._checkPosition, this), 10));

    $(window).on(
      'modal:show',
      $.proxy(function () {
        if (this.$stickyWrapper.hasClass('is-sticky')) {
          var scrollWidth = window.innerWidth - $(document).width();
          this.$stickyWrapper.css('margin-right', scrollWidth);
        }
      }, this)
    );

    $(window).on(
      'modal:hide',
      $.proxy(function () {
        this.$stickyWrapper.css('margin-right', '');
      }, this)
    );

    this._checkPosition();

    this.$buttonBackToTop.click(
      $.proxy(function (event) {
        if (this.isAnimationDisabled) {
          $(window).scrollTop(0);
        } else {
          $('html, body').animate({ scrollTop: 0 }, 500, 'swing');
        }
      }, this)
    );

    this.$buttonSeeMore.click(
      $.proxy(function (event) {
        if (this.isAnimationDisabled) {
          GeneCore.utils.anchorsUtil.scrollToYPosition(
            this.element.offset().top,
            true
          );
        } else {
          GeneCore.utils.anchorsUtil.scrollToYPosition(
            this.element.offset().top,
            false
          );
        }
      }, this)
    );

    this.$buttonMinimize.click(
      $.proxy(function (event) {
        if (!this.isMinimized) {
          this._setSafetyBarMinimized();
        } else {
          this._setSafetyBarNormal();
        }
        this._checkPosition(true);
      }, this)
    );
  },

  _checkMinimizedState: function () {
    var cookie = GeneCore.utils.cookieUtils.getCookie(this.minimizedCookieId);
    if (cookie != null) {
      this._setSafetyBarMinimized();
    }
  },

  _setSafetyBarMinimized: function () {
    this.isMinimized = true;
    this.stickyHeight = this.$header.outerHeight();
    this.$buttonMinimize.addClass('cmp-safetybar__button-minimize-minimized');

    GeneCore.utils.cookieUtils.setCookie(this.minimizedCookieId, 'true', 1);
  },

  _setSafetyBarNormal: function () {
    this.isMinimized = false;
    this.$buttonMinimize.removeClass(
      'cmp-safetybar__button-minimize-minimized'
    );

    GeneCore.utils.cookieUtils.deleteCookie(this.minimizedCookieId);
  },

  _checkPosition: function (forceUpdate) {
    this.spotlightContentHeight = this.$spotlightContent.innerHeight();

    var windowHeight = window.innerHeight,
      elementTop = this.element.offset().top,
      triggerHeight = elementTop - windowHeight + this.stickyHeight;

    if (triggerHeight > 0) {
      if (window.pageYOffset < triggerHeight) {
        if (!this.isSticky || forceUpdate) {
          this._setSafetyBarSticky();
          $(window).trigger('safetybar:resize', {
            isSticky: true,
            height: this.stickyHeight,
          });
        }
      } else if (window.pageYOffset > triggerHeight) {
        if (this.isSticky || forceUpdate) {
          this._setSafetyBarInactive(true);
          $(window).trigger('safetybar:resize', { isSticky: false, height: 0 });
        }
      }
    } else {
      this._setSafetyBarInactive(false);
      $(window).trigger('safetybar:resize', { isSticky: false, height: 0 });
    }

    if (this.isMinimized && this.isSticky) {
      this._setSafetyBarMinimized();
      $(window).trigger('safetybar:resize', {
        isSticky: true,
        height: this.stickyHeight,
      });
    }

    if (!this.isReady) {
      this.isReady = true;
      setTimeout(function () {
        $(window).trigger('safetybar:ready');
      }, 350);
    }
  },

  _setSafetyBarSticky: function () {
    this.isSticky = true;
    this.element.css('height', this.spotlightContentHeight);
    this.$buttonBackToTop.hide();
    this.$buttonSeeMore.show();

    if (this.isMinimized) {
      this.stickyHeight = this.$header.outerHeight();
    } else {
      if (this.smallMediaQuery.matches) {
        this.stickyHeight = this.smallDeviceHeight;
      } else {
        this.stickyHeight = this.mediumDeviceHeight;
      }
    }

    this.$stickyWrapper.addClass('is-sticky').css('height', this.stickyHeight);
  },

  _setSafetyBarInactive: function (displayBackToTop) {
    this.isSticky = false;
    this.element.css('height', '');
    this.$stickyWrapper.removeClass('is-sticky').css('height', '');
    this.$buttonSeeMore.hide();
    if (displayBackToTop) {
      this.$buttonBackToTop.show();
    }
  },

  getHeight: function () {
    return this.stickyHeight;
  },

  isSaftyBarSticky: function () {
    return this.isSticky;
  },

  checkPosition: function () {
    this._checkPosition();
  },
});

(function ($) {
  $('.cmp-safetybar').safetyBar();
})(jQuery);

$.widget('gene.patientAssistanceTool', {
  _create: function () {
    this.brandCode = this.element.data('brand-code');

    this.$main = this.element.find('.cmp-pat__main-content');
    this.$questions = this.element.find('.cmp-pat__item');
    this.$results = this.element.find('.cmp-pat__results');
    this.$resultsContainer = this.element.find('.cmp-pat__results-content');
    this.$options = this.element.find('.cmp-pat__options');
    this.$startOver = this.element.find('.start-over');
    this.$updateResponse = this.element.find('.update-response');

    this.currentActiveQuestion = 0;
    this.questionHistory = [];

    // Disable all questions, activate the first.
    this._setActiveQuestion(0);

    // Current view is main
    this.currentView = 'main';

    this._initEvents();
  },

  // Initialize event handlers
  _initEvents: function () {
    var self = this;

    // Handle yes / no answers
    this.$options.find('button').on('click', function () {
      if (!$(this).parents('li').hasClass('disabled')) {
        $(this).toggleClass('active');
        self._handleAnswer($(this));
      }
    });

    // Start over
    this.$startOver.on('click', function () {
      self._switchViews('main');
      self.questionHistory = [];
      self.$options.find('button').removeClass('active');
      self.$questions.removeClass('active');
      self._setActiveQuestion(0);
    });

    // Update Response
    this.$updateResponse.on('click', function () {
      var next;
      if (self.currentActiveQuestion !== 0) {
        self._switchViews('main');
        self.questionHistory.pop();
        next = self.questionHistory.pop();
        self.$questions.eq(self.currentActiveQuestion).removeClass('active');
        self.$options.eq(next).find('button').removeClass('active');
        self._setActiveQuestion(next);
      }
    });

    if (this.brandCode) {
      this._handleBrandCode();
    }
  },

  // Set currently active question
  _setActiveQuestion: function (index) {
    var $next = this.$questions.eq(index);

    this.questionHistory.push(index);

    if (index >= 0) {
      this.$questions.addClass('disabled');
      $next.removeClass('disabled');
      $next.addClass('active');
      this.currentActiveQuestion = index;

      // Update response button
      if (this.currentActiveQuestion === 0) {
        this.$updateResponse.hide();
        this.$startOver.hide();
      } else {
        this.$updateResponse.show();
        this.$startOver.show();
      }
    }
  },

  // Handler for when the user answers a question
  _handleAnswer: function ($el) {
    var action = $el.data('action'),
      type,
      index;

    type = !!action.match(/question_/g) ? 'question' : 'result';

    if (action === 'continue') {
      this._setActiveQuestion(this.currentActiveQuestion + 1);
    } else if (type === 'result') {
      this._setActiveQuestion(this.currentActiveQuestion + 1);
      this._switchViews(action);
      GeneCore.utils.anchorsUtil.scrollToYPosition(
        this.element.offset().top,
        false
      );
    } else if (type === 'question') {
      index = this.$questions.index($('.' + action));
      this._setActiveQuestion(index);
    }
  },

  // Switch the view
  _switchViews: function (viewName) {
    if (this.currentView !== viewName) {
      $('[data-pat-view=' + this.currentView + ']').hide();
      $('[data-pat-view=' + viewName + ']').show();
      this.currentView = viewName;
    }
  },

  // Handle brand code
  _handleBrandCode: function () {
    var brandCode = this.brandCode;

    this.$results.each(function (index, element) {
      // Separate hash from url
      var href = $(this).find('a').attr('href'),
        currentUrl = href ? href.split('#')[0] : '',
        hash = href ? href.split('#')[1] : false;

      // Append campaign parameter to url
      if ($(this).hasClass('result_gatcf')) {
        currentUrl = currentUrl + '?intc=' + brandCode + '_patlearnmore_gatcf';
      } else if ($(this).hasClass('result_foundations')) {
        currentUrl =
          currentUrl +
          '?intc=' +
          brandCode +
          '_patlearnmore_assistancefoundations';
      } else if ($(this).hasClass('result_copaycard')) {
        currentUrl =
          currentUrl + '?intc=' + brandCode + '_patlearnmore_copaycard';
      }

      // Append original hash to final url
      if (hash) {
        currentUrl += '#' + hash;
      }

      $(this).find('a').attr('href', currentUrl);
    });
  },
});

(function ($) {
  //Initialize PAT widget
  $('.cmp-pat').patientAssistanceTool();
})(jQuery);

(function () {
  'use strict';

  var NS = 'cmp';
  var IS = 'accordion';

  var keyCodes = {
    ENTER: 13,
    SPACE: 32,
    END: 35,
    HOME: 36,
    ARROW_LEFT: 37,
    ARROW_UP: 38,
    ARROW_RIGHT: 39,
    ARROW_DOWN: 40,
  };

  var selectors = {
    self: '[data-' + NS + '-is="' + IS + '"]',
  };

  var cssClasses = {
    button: {
      disabled: 'cmp-accordion__button--disabled',
      expanded: 'cmp-accordion__button--expanded',
    },
    panel: {
      hidden: 'cmp-accordion__panel--hidden',
      expanded: 'cmp-accordion__panel--expanded',
    },
  };

  var dataAttributes = {
    item: {
      expanded: 'data-cmp-expanded',
    },
  };

  var properties = {
    /**
     * Determines whether a single accordion item is forced to be expanded at a time.
     * Expanding one item will collapse all others.
     *
     * @memberof Accordion
     * @type {Boolean}
     * @default false
     */
    singleExpansion: {
      default: false,
      transform: function (value) {
        return !(value === null || typeof value === 'undefined');
      },
    },
  };

  /**
   * Accordion Configuration.
   *
   * @typedef {Object} AccordionConfig Represents an Accordion configuration
   * @property {HTMLElement} element The HTMLElement representing the Accordion
   * @property {Object} options The Accordion options
   */

  /**
   * Accordion.
   *
   * @class Accordion
   * @classdesc An interactive Accordion component for toggling panels of related content
   * @param {AccordionConfig} config The Accordion configuration
   */
  function Accordion(config) {
    var that = this;

    if (config && config.element) {
      init(config);
    }

    /**
     * Initializes the Accordion.
     *
     * @private
     * @param {AccordionConfig} config The Accordion configuration
     */
    function init(config) {
      // prevents multiple initialization
      config.element.removeAttribute('data-' + NS + '-is');

      setupProperties(config.options);
      cacheElements(config.element);

      if (that._elements['item']) {
        // ensures multiple element types are arrays.
        that._elements['item'] = Array.isArray(that._elements['item'])
          ? that._elements['item']
          : [that._elements['item']];
        that._elements['button'] = Array.isArray(that._elements['button'])
          ? that._elements['button']
          : [that._elements['button']];
        that._elements['panel'] = Array.isArray(that._elements['panel'])
          ? that._elements['panel']
          : [that._elements['panel']];

        if (that._properties.singleExpansion) {
          var expandedItems = getExpandedItems();
          // no expanded item annotated, force the first item to display.
          if (expandedItems.length === 0) {
            toggle(0);
          }
          // multiple expanded items annotated, display the last item open.
          if (expandedItems.length > 1) {
            toggle(expandedItems.length - 1);
          }
        }

        refreshItems();
        bindEvents();

        if (
          window.Granite &&
          window.Granite.author &&
          window.Granite.author.MessageChannel
        ) {
          /*
           * Editor message handling:
           * - subscribe to "cmp.panelcontainer" message requests sent by the editor frame
           * - check that the message data panel container type is correct and that the id (path) matches this specific Accordion component
           * - if so, route the "navigate" operation to enact a navigation of the Accordion based on index data
           */
          new window.Granite.author.MessageChannel(
            'cqauthor',
            window
          ).subscribeRequestMessage('cmp.panelcontainer', function (message) {
            if (
              message.data &&
              message.data.type === 'cmp-accordion' &&
              message.data.id ===
                that._elements.self.dataset['cmpPanelcontainerId']
            ) {
              if (message.data.operation === 'navigate') {
                // switch to single expansion mode when navigating in edit mode.
                var singleExpansion = that._properties.singleExpansion;
                that._properties.singleExpansion = true;
                toggle(message.data.index);

                // revert to the configured state.
                that._properties.singleExpansion = singleExpansion;
              }
            }
          });
        }
        var $items = $(that._elements['item']);

        $items.each(function () {
          setItemMaxHeight(this);
        });
        window.addEventListener('resize', function () {
          $items.each(function () {
            setItemMaxHeight(this);
          });
        });

        setTimeout(function () {
          $(that._elements.self).addClass('cmp-accordion--initialized');
        }, 100);
      }
    }

    /**
     * Caches the Accordion elements as defined via the {@code data-accordion-hook="ELEMENT_NAME"} markup API.
     *
     * @private
     * @param {HTMLElement} wrapper The Accordion wrapper element
     */
    function cacheElements(wrapper) {
      that._elements = {};
      that._elements.self = wrapper;
      var hooks = that._elements.self.querySelectorAll(
        '[data-' + NS + '-hook-' + IS + ']'
      );

      for (var i = 0; i < hooks.length; i++) {
        var hook = hooks[i];
        if (hook.closest('.' + NS + '-' + IS) === that._elements.self) {
          // only process own accordion elements
          var capitalized = IS;
          capitalized =
            capitalized.charAt(0).toUpperCase() + capitalized.slice(1);
          var key = hook.dataset[NS + 'Hook' + capitalized];
          if (that._elements[key]) {
            if (!Array.isArray(that._elements[key])) {
              var tmp = that._elements[key];
              that._elements[key] = [tmp];
            }
            that._elements[key].push(hook);
          } else {
            that._elements[key] = hook;
          }
        }
      }
    }

    /**
     * Sets up properties for the Accordion based on the passed options.
     *
     * @private
     * @param {Object} options The Accordion options
     */
    function setupProperties(options) {
      that._properties = {};

      for (var key in properties) {
        if (properties.hasOwnProperty(key)) {
          var property = properties[key];
          var value = null;

          if (options && options[key] != null) {
            value = options[key];

            // transform the provided option
            if (property && typeof property.transform === 'function') {
              value = property.transform(value);
            }
          }

          if (value === null) {
            // value still null, take the property default
            value = properties[key]['default'];
          }

          that._properties[key] = value;
        }
      }
    }

    /**
     * Binds Accordion event handling.
     *
     * @private
     */
    function bindEvents() {
      var buttons = that._elements['button'];
      if (buttons) {
        for (var i = 0; i < buttons.length; i++) {
          (function (index) {
            buttons[i].addEventListener('click', function (event) {
              var isExpanded = $(this).attr('aria-expanded') === 'true';

              toggle(index);
              focusButton(index);

              if (!isExpanded) {
                scrollToItem(this);
              }
            });
            buttons[i].addEventListener('keydown', function (event) {
              onButtonKeyDown(event, index);
            });
          })(i);
        }
      }
    }

    /**
     * Handles button keydown events.
     *
     * @private
     * @param {Object} event The keydown event
     * @param {Number} index The index of the button triggering the event
     */
    function onButtonKeyDown(event, index) {
      var lastIndex = that._elements['button'].length - 1;

      switch (event.keyCode) {
        case keyCodes.ARROW_LEFT:
        case keyCodes.ARROW_UP:
          event.preventDefault();
          if (index > 0) {
            focusButton(index - 1);
          }
          break;
        case keyCodes.ARROW_RIGHT:
        case keyCodes.ARROW_DOWN:
          event.preventDefault();
          if (index < lastIndex) {
            focusButton(index + 1);
          }
          break;
        case keyCodes.HOME:
          event.preventDefault();
          focusButton(0);
          break;
        case keyCodes.END:
          event.preventDefault();
          focusButton(lastIndex);
          break;
        case keyCodes.ENTER:
        case keyCodes.SPACE:
          event.preventDefault();
          toggle(index);
          focusButton(index);
          break;
        default:
          return;
      }
    }

    /**
     * General handler for toggle of an item.
     *
     * @private
     * @param {Number} index The index of the item to toggle
     */
    function toggle(index) {
      var item = that._elements['item'][index];
      if (item) {
        if (that._properties.singleExpansion) {
          // ensure only a single item is expanded if single expansion is enabled.
          for (var i = 0; i < that._elements['item'].length; i++) {
            if (that._elements['item'][i] !== item) {
              var expanded = getItemExpanded(that._elements['item'][i]);
              if (expanded) {
                setItemExpanded(that._elements['item'][i], false);
              }
            }
          }
          setItemExpanded(item, true);
        } else {
          setItemExpanded(item, !getItemExpanded(item));
        }
      }
    }

    /**
     * Scrolls to a blade on the page if the blade is not open already
     * @param element to scroll to
     */
    function scrollToItem(element) {
      var position = $(element).offset();
      GeneCore.utils.anchorsUtil.scrollToYPosition(position.top, false);
    }

    /**
     * Sets an item's expanded state based on the provided flag and refreshes its internals.
     *
     * @private
     * @param {HTMLElement} item The item to mark as expanded, or not expanded
     * @param {Boolean} expanded true to mark the item expanded, false otherwise
     */
    //TODO fix this
    function setItemExpanded(item, expanded) {
      var $item = $(item);
      if (expanded) {
        item.setAttribute(dataAttributes.item.expanded, '');
      } else {
        item.removeAttribute(dataAttributes.item.expanded);
      }
      refreshItem(item);
      setItemMaxHeight(item);
    }

    function setItemMaxHeight(item) {
      var $item = $(item);
      var $itemPanel = $item.find('.cmp-accordion__panel');
      if ($itemPanel.hasClass(cssClasses.panel.expanded)) {
        $itemPanel.css('display', '');
        var itemHeight = $item.find('.container').outerHeight();
        $itemPanel.css('max-height', itemHeight);
      } else {
        $itemPanel.css('display', 'none');
        $itemPanel.css('max-height', '');
      }
    }

    /**
     * Gets an item's expanded state.
     *
     * @private
     * @param {HTMLElement} item The item for checking its expanded state
     * @returns {Boolean} true if the item is expanded, false otherwise
     */
    function getItemExpanded(item) {
      return item && item.dataset && item.dataset['cmpExpanded'] !== undefined;
    }

    /**
     * Refreshes an item based on its expanded state.
     *
     * @private
     * @param {HTMLElement} item The item to refresh
     */
    function refreshItem(item) {
      var expanded = getItemExpanded(item);
      if (expanded) {
        expandItem(item);
      } else {
        collapseItem(item);
      }
    }

    /**
     * Refreshes all items based on their expanded state.
     *
     * @private
     */
    function refreshItems() {
      for (var i = 0; i < that._elements['item'].length; i++) {
        refreshItem(that._elements['item'][i]);
      }
    }

    /**
     * Returns all expanded items.
     *
     * @private
     * @returns {HTMLElement[]} The expanded items
     */
    function getExpandedItems() {
      var expandedItems = [];

      for (var i = 0; i < that._elements['item'].length; i++) {
        var item = that._elements['item'][i];
        var expanded = getItemExpanded(item);
        if (expanded) {
          expandedItems.push(item);
        }
      }

      return expandedItems;
    }

    /**
     * Annotates the item and its internals with
     * the necessary style and accessibility attributes to indicate it is expanded.
     *
     * @private
     * @param {HTMLElement} item The item to annotate as expanded
     */
    function expandItem(item) {
      var index = that._elements['item'].indexOf(item);
      if (index > -1) {
        var button = that._elements['button'][index];
        var panel = that._elements['panel'][index];
        button.classList.add(cssClasses.button.expanded);
        button.setAttribute('aria-expanded', true);
        updateDataAnalytics('state', 'accordion-anchor-open', button);
        panel.classList.add(cssClasses.panel.expanded);
        panel.classList.remove(cssClasses.panel.hidden);
        panel.setAttribute('aria-hidden', false);

        if (that._properties.singleExpansion) {
          button.classList.add(cssClasses.button.disabled);
          button.setAttribute('aria-disabled', true);
        }
      }
    }

    /**
     * Annotates the item and its internals with
     * the necessary style and accessibility attributes to indicate it is not expanded.
     *
     * @private
     * @param {HTMLElement} item The item to annotate as not expanded
     */
    function collapseItem(item) {
      var index = that._elements['item'].indexOf(item);
      if (index > -1) {
        var button = that._elements['button'][index];
        var panel = that._elements['panel'][index];
        button.classList.remove(cssClasses.button.disabled);
        button.classList.remove(cssClasses.button.expanded);
        button.removeAttribute('aria-disabled');
        button.setAttribute('aria-expanded', false);
        updateDataAnalytics('state', 'accordion-anchor-closed', button);
        panel.classList.add(cssClasses.panel.hidden);
        panel.classList.remove(cssClasses.panel.expanded);
        panel.setAttribute('aria-hidden', true);
      }
    }

    /**
     * Updates the analytics json
     * @param propertyName of the analytics json property to update
     * @param propertyValue to set the property to
     * @param element javascript element that contains the analytics json
     */
    function updateDataAnalytics(propertyName, propertyValue, element) {
      if (element.dataset.analytics) {
        let analytics = JSON.parse(
          JSON.parse('"' + element.dataset.analytics + '"')
        );
        analytics[propertyName] = propertyValue;
        element.setAttribute(
          'data-analytics',
          JSON.stringify(analytics).replace(/"/g, '\\"')
        );
      }
    }

    /**
     * Focuses the button at the provided index.
     *
     * @private
     * @param {Number} index The index of the button to focus
     */
    function focusButton(index) {
      var button = that._elements['button'][index];
      button.focus();
    }

    //Handle accordion link clicks in page content
    $("a[href^='#accordion']").click(function (e) {
      e.preventDefault();
      var targetId = $(this).attr('href').replace('#', '');
      var accordionBtn = $(
        '.cmp-accordion__button[data-accordion-target="' + targetId + '"]'
      );
      if (accordionBtn) {
        var accordionItem = accordionBtn.closest('.cmp-accordion__item');
        if (accordionItem) {
          setItemExpanded(accordionItem[0], true);
          scrollToItem(accordionItem[0]);
        }
      }
    });
  }

  /**
   * Reads options data from the Accordion wrapper element, defined via {@code data-cmp-*} data attributes.
   *
   * @private
   * @param {HTMLElement} element The Accordion element to read options data from
   * @returns {Object} The options read from the component data attributes
   */
  function readData(element) {
    var data = element.dataset;
    var options = [];
    var capitalized = IS;
    capitalized = capitalized.charAt(0).toUpperCase() + capitalized.slice(1);
    var reserved = ['is', 'hook' + capitalized];

    for (var key in data) {
      if (data.hasOwnProperty(key)) {
        var value = data[key];

        if (key.indexOf(NS) === 0) {
          key = key.slice(NS.length);
          key = key.charAt(0).toLowerCase() + key.substring(1);

          if (reserved.indexOf(key) === -1) {
            options[key] = value;
          }
        }
      }
    }
    return options;
  }

  function expandDeepLink(tabId, deeplinkId) {
    var $bladeSelector = $('[data-accordion-target=' + tabId + ']');
    var position = $bladeSelector.offset();
    var panel = $bladeSelector.parent().next('.cmp-accordion__panel');
    var item = $(panel).closest('.cmp-accordion__item').get(0);
    item.setAttribute(dataAttributes.item.expanded, '');
    $bladeSelector.addClass(cssClasses.button.expanded);
    $bladeSelector.attr('aria-expanded', true);
    $(panel).addClass(cssClasses.panel.expanded);
    $(panel).removeClass(cssClasses.panel.hidden);
    $(panel).attr('aria-hidden', false);
    $(panel).css('display', '');
    var itemHeight = $(panel).closest('.container').outerHeight();
    $(panel).css('max-height', itemHeight);

    if (deeplinkId) {
      GeneCore.utils.anchorsUtil.scrollToYPosition(
        $('#' + deeplinkId).offset().top,
        false
      );
    } else {
      GeneCore.utils.anchorsUtil.scrollToYPosition(position.top, false);
    }
  }

  /**
   * Document ready handler and DOM mutation observers. Initializes Accordion components as necessary.
   *
   * @private
   */
  function onDocumentReady() {
    var elements = document.querySelectorAll(selectors.self);
    for (var i = 0; i < elements.length; i++) {
      new Accordion({ element: elements[i], options: readData(elements[i]) });
    }

    var MutationObserver =
      window.MutationObserver ||
      window.WebKitMutationObserver ||
      window.MozMutationObserver;
    var body = document.querySelector('body');
    var observer = new MutationObserver(function (mutations) {
      mutations.forEach(function (mutation) {
        // needed for IE
        var nodesArray = [].slice.call(mutation.addedNodes);
        if (nodesArray.length > 0) {
          nodesArray.forEach(function (addedNode) {
            if (addedNode.querySelectorAll) {
              var elementsArray = [].slice.call(
                addedNode.querySelectorAll(selectors.self)
              );
              elementsArray.forEach(function (element) {
                new Accordion({ element: element, options: readData(element) });
              });
            }
          });
        }
      });
    });

    observer.observe(body, {
      subtree: true,
      childList: true,
      characterData: true,
    });

    //check for deeplink
    var urlHash = GeneCore.utils.generalUtils.getUrlHash();
    if (urlHash && urlHash.startsWith('accordion')) {
      var deeplinks = urlHash.split('$$');
      //deeplinks[0] = accordionId
      //deeplinks[1] = Deep Link inside the accordion
      expandDeepLink(deeplinks[0], deeplinks[1] ? deeplinks[1] : null);
    }
  }

  if (document.readyState !== 'loading') {
    onDocumentReady();
  } else {
    document.addEventListener('DOMContentLoaded', onDocumentReady());
  }
})();

/*******************************************************************************
 * Copyright 2018 Adobe
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 ******************************************************************************/
(function () {
  'use strict';

  var NS = 'cmp';
  var IS = 'carousel';

  var keyCodes = {
    SPACE: 32,
    END: 35,
    HOME: 36,
    ARROW_LEFT: 37,
    ARROW_UP: 38,
    ARROW_RIGHT: 39,
    ARROW_DOWN: 40,
  };

  var selectors = {
    self: '[data-' + NS + '-is="' + IS + '"]',
  };

  var properties = {
    /**
     * Determines whether the Carousel will automatically transition between slides
     *
     * @memberof Carousel
     * @type {Boolean}
     * @default false
     */
    autoplay: {
      default: false,
      transform: function (value) {
        return !(value === null || typeof value === 'undefined');
      },
    },
    /**
     * Duration (in milliseconds) before automatically transitioning to the next slide
     *
     * @memberof Carousel
     * @type {Number}
     * @default 5000
     */
    delay: {
      default: 5000,
      transform: function (value) {
        value = parseFloat(value);
        return !isNaN(value) ? value : null;
      },
    },
    /**
     * Determines whether automatic pause on hovering the carousel is disabled
     *
     * @memberof Carousel
     * @type {Boolean}
     * @default false
     */
    autopauseDisabled: {
      default: false,
      transform: function (value) {
        return !(value === null || typeof value === 'undefined');
      },
    },
  };

  /**
   * Carousel Configuration
   *
   * @typedef {Object} CarouselConfig Represents a Carousel configuration
   * @property {HTMLElement} element The HTMLElement representing the Carousel
   * @property {Object} options The Carousel options
   */

  /**
   * Carousel
   *
   * @class Carousel
   * @classdesc An interactive Carousel component for navigating a list of generic items
   * @param {CarouselConfig} config The Carousel configuration
   */
  function Carousel(config) {
    var that = this;

    if (config && config.element) {
      init(config);
    }

    /**
     * Initializes the Carousel
     *
     * @private
     * @param {CarouselConfig} config The Carousel configuration
     */
    function init(config) {
      // prevents multiple initialization
      config.element.removeAttribute('data-' + NS + '-is');

      setupProperties(config.options);
      cacheElements(config.element);

      that._active = 0;
      that._paused = false;

      if (that._elements.item) {
        refreshActive();
        bindEvents();
        resetAutoplayInterval();
        refreshPlayPauseActions();
      }

      if (
        window.Granite &&
        window.Granite.author &&
        window.Granite.author.MessageChannel
      ) {
        /*
         * Editor message handling:
         * - subscribe to "cmp.panelcontainer" message requests sent by the editor frame
         * - check that the message data panel container type is correct and that the id (path) matches this specific Carousel component
         * - if so, route the "navigate" operation to enact a navigation of the Carousel based on index data
         */
        new window.Granite.author.MessageChannel(
          'cqauthor',
          window
        ).subscribeRequestMessage('cmp.panelcontainer', function (message) {
          if (
            message.data &&
            message.data.type === 'cmp-carousel' &&
            message.data.id ===
              that._elements.self.dataset['cmpPanelcontainerId']
          ) {
            if (message.data.operation === 'navigate') {
              navigate(message.data.index);
            }
          }
        });
      }
    }

    /**
     * Caches the Carousel elements as defined via the {@code data-carousel-hook="ELEMENT_NAME"} markup API
     *
     * @private
     * @param {HTMLElement} wrapper The Carousel wrapper element
     */
    function cacheElements(wrapper) {
      that._elements = {};
      that._elements.self = wrapper;
      var hooks = that._elements.self.querySelectorAll(
        '[data-' + NS + '-hook-' + IS + ']'
      );

      for (var i = 0; i < hooks.length; i++) {
        var hook = hooks[i];
        var capitalized = IS;
        capitalized =
          capitalized.charAt(0).toUpperCase() + capitalized.slice(1);
        var key = hook.dataset[NS + 'Hook' + capitalized];
        if (that._elements[key]) {
          if (!Array.isArray(that._elements[key])) {
            var tmp = that._elements[key];
            that._elements[key] = [tmp];
          }
          that._elements[key].push(hook);
        } else {
          that._elements[key] = hook;
        }
      }
    }

    /**
     * Sets up properties for the Carousel based on the passed options.
     *
     * @private
     * @param {Object} options The Carousel options
     */
    function setupProperties(options) {
      that._properties = {};

      for (var key in properties) {
        if (properties.hasOwnProperty(key)) {
          var property = properties[key];
          var value = null;

          if (options && options[key] != null) {
            value = options[key];

            // transform the provided option
            if (property && typeof property.transform === 'function') {
              value = property.transform(value);
            }
          }

          if (value === null) {
            // value still null, take the property default
            value = properties[key]['default'];
          }

          that._properties[key] = value;
        }
      }
    }

    /**
     * Binds Carousel event handling
     *
     * @private
     */
    function bindEvents() {
      if (that._elements['previous']) {
        that._elements['previous'].addEventListener('click', function () {
          navigate(getPreviousIndex());
        });
      }

      if (that._elements['next']) {
        that._elements['next'].addEventListener('click', function () {
          navigate(getNextIndex());
        });
      }

      var indicators = that._elements['indicator'];
      if (indicators) {
        for (var i = 0; i < indicators.length; i++) {
          (function (index) {
            indicators[i].addEventListener('click', function (event) {
              navigateAndFocusIndicator(index);
            });
          })(i);
        }
      }

      if (that._elements['pause']) {
        if (that._properties.autoplay) {
          that._elements['pause'].addEventListener('click', onPauseClick);
        }
      }

      if (that._elements['play']) {
        if (that._properties.autoplay) {
          that._elements['play'].addEventListener('click', onPlayClick);
        }
      }

      that._elements.self.addEventListener('keydown', onKeyDown);

      if (!that._properties.autopauseDisabled) {
        that._elements.self.addEventListener('mouseenter', onMouseEnter);
        that._elements.self.addEventListener('mouseleave', onMouseLeave);
      }
    }

    /**
     * Handles carousel keydown events
     *
     * @private
     * @param {Object} event The keydown event
     */
    function onKeyDown(event) {
      var index = that._active;
      var lastIndex = that._elements['indicator'].length - 1;

      switch (event.keyCode) {
        case keyCodes.ARROW_LEFT:
        case keyCodes.ARROW_UP:
          event.preventDefault();
          if (index > 0) {
            navigateAndFocusIndicator(index - 1);
          }
          break;
        case keyCodes.ARROW_RIGHT:
        case keyCodes.ARROW_DOWN:
          event.preventDefault();
          if (index < lastIndex) {
            navigateAndFocusIndicator(index + 1);
          }
          break;
        case keyCodes.HOME:
          event.preventDefault();
          navigateAndFocusIndicator(0);
          break;
        case keyCodes.END:
          event.preventDefault();
          navigateAndFocusIndicator(lastIndex);
          break;
        case keyCodes.SPACE:
          if (
            that._properties.autoplay &&
            event.target !== that._elements['previous'] &&
            event.target !== that._elements['next']
          ) {
            event.preventDefault();
            if (!that._paused) {
              pause();
            } else {
              play();
            }
          }
          if (event.target === that._elements['pause']) {
            that._elements['play'].focus();
          }
          if (event.target === that._elements['play']) {
            that._elements['pause'].focus();
          }
          break;
        default:
          return;
      }
    }

    /**
     * Handles carousel mouseenter events
     *
     * @private
     * @param {Object} event The mouseenter event
     */
    function onMouseEnter(event) {
      clearAutoplayInterval();
    }

    /**
     * Handles carousel mouseleave events
     *
     * @private
     * @param {Object} event The mouseleave event
     */
    function onMouseLeave(event) {
      resetAutoplayInterval();
    }

    /**
     * Handles pause element click events
     *
     * @private
     * @param {Object} event The click event
     */
    function onPauseClick(event) {
      pause();
      that._elements['play'].focus();
    }

    /**
     * Handles play element click events
     *
     * @private
     * @param {Object} event The click event
     */
    function onPlayClick() {
      play();
      that._elements['pause'].focus();
    }

    /**
     * Pauses the playing of the Carousel. Sets {@code Carousel#_paused} marker.
     * Only relevant when autoplay is enabled
     *
     * @private
     */
    function pause() {
      that._paused = true;
      clearAutoplayInterval();
      refreshPlayPauseActions();
    }

    /**
     * Enables the playing of the Carousel. Sets {@code Carousel#_paused} marker.
     * Only relevant when autoplay is enabled
     *
     * @private
     */
    function play() {
      that._paused = false;

      // If the Carousel is hovered, don't begin auto transitioning until the next mouse leave event
      var hovered = false;
      if (that._elements.self.parentElement) {
        hovered =
          that._elements.self.parentElement.querySelector(':hover') ===
          that._elements.self;
      }
      if (that._properties.autopauseDisabled || !hovered) {
        resetAutoplayInterval();
      }

      refreshPlayPauseActions();
    }

    /**
     * Refreshes the play/pause action markup based on the {@code Carousel#_paused} state
     *
     * @private
     */
    function refreshPlayPauseActions() {
      setActionDisabled(that._elements['pause'], that._paused);
      setActionDisabled(that._elements['play'], !that._paused);
    }

    /**
     * Refreshes the item markup based on the current {@code Carousel#_active} index
     *
     * @private
     */
    function refreshActive() {
      var items = that._elements['item'];
      var indicators = that._elements['indicator'];

      if (items) {
        if (Array.isArray(items)) {
          for (var i = 0; i < items.length; i++) {
            if (i === parseInt(that._active)) {
              items[i].classList.add('cmp-carousel__item--active');
              items[i].removeAttribute('aria-hidden');
              indicators[i].classList.add('cmp-carousel__indicator--active');
              indicators[i].setAttribute('aria-selected', true);
              indicators[i].setAttribute('tabindex', '0');
            } else {
              items[i].classList.remove('cmp-carousel__item--active');
              items[i].setAttribute('aria-hidden', true);
              indicators[i].classList.remove('cmp-carousel__indicator--active');
              indicators[i].setAttribute('aria-selected', false);
              indicators[i].setAttribute('tabindex', '-1');
            }
          }
        } else {
          // only one item
          items.classList.add('cmp-carousel__item--active');
          indicators.classList.add('cmp-carousel__indicator--active');
        }
      }
    }

    /**
     * Focuses the element and prevents scrolling the element into view
     *
     * @param {HTMLElement} element Element to focus
     */
    function focusWithoutScroll(element) {
      var x = window.scrollX || window.pageXOffset;
      var y = window.scrollY || window.pageYOffset;
      element.focus();
      window.scrollTo(x, y);
    }

    /**
     * Retrieves the next active index, with looping
     *
     * @private
     * @returns {Number} Index of the next carousel item
     */
    function getNextIndex() {
      return that._active === that._elements['item'].length - 1
        ? 0
        : that._active + 1;
    }

    /**
     * Retrieves the previous active index, with looping
     *
     * @private
     * @returns {Number} Index of the previous carousel item
     */
    function getPreviousIndex() {
      return that._active === 0
        ? that._elements['item'].length - 1
        : that._active - 1;
    }

    /**
     * Navigates to the item at the provided index
     *
     * @private
     * @param {Number} index The index of the item to navigate to
     */
    function navigate(index) {
      if (index < 0 || index > that._elements['item'].length - 1) {
        return;
      }

      that._active = index;
      refreshActive();

      // reset the autoplay transition interval following navigation, if not already hovering the carousel
      if (that._elements.self.parentElement) {
        if (
          that._elements.self.parentElement.querySelector(':hover') !==
          that._elements.self
        ) {
          resetAutoplayInterval();
        }
      }
    }

    /**
     * Navigates to the item at the provided index and ensures the active indicator gains focus
     *
     * @private
     * @param {Number} index The index of the item to navigate to
     */
    function navigateAndFocusIndicator(index) {
      navigate(index);
      focusWithoutScroll(that._elements['indicator'][index]);
    }

    /**
     * Starts/resets automatic slide transition interval
     *
     * @private
     */
    function resetAutoplayInterval() {
      if (that._paused || !that._properties.autoplay) {
        return;
      }
      clearAutoplayInterval();
      that._autoplayIntervalId = window.setInterval(function () {
        if (document.visibilityState && document.hidden) {
          return;
        }
        var indicators = that._elements['indicators'];
        if (
          indicators !== document.activeElement &&
          indicators.contains(document.activeElement)
        ) {
          // if an indicator has focus, ensure we switch focus following navigation
          navigateAndFocusIndicator(getNextIndex());
        } else {
          navigate(getNextIndex());
        }
      }, that._properties.delay);
    }

    /**
     * Clears/pauses automatic slide transition interval
     *
     * @private
     */
    function clearAutoplayInterval() {
      window.clearInterval(that._autoplayIntervalId);
      that._autoplayIntervalId = null;
    }

    /**
     * Sets the disabled state for an action and toggles the appropriate CSS classes
     *
     * @private
     * @param {HTMLElement} action Action to disable
     * @param {Boolean} [disable] {@code true} to disable, {@code false} to enable
     */
    function setActionDisabled(action, disable) {
      if (!action) {
        return;
      }
      if (disable !== false) {
        action.disabled = true;
        action.classList.add('cmp-carousel__action--disabled');
      } else {
        action.disabled = false;
        action.classList.remove('cmp-carousel__action--disabled');
      }
    }
  }

  /**
   * Reads options data from the Carousel wrapper element, defined via {@code data-cmp-*} data attributes
   *
   * @private
   * @param {HTMLElement} element The Carousel element to read options data from
   * @returns {Object} The options read from the component data attributes
   */
  function readData(element) {
    var data = element.dataset;
    var options = [];
    var capitalized = IS;
    capitalized = capitalized.charAt(0).toUpperCase() + capitalized.slice(1);
    var reserved = ['is', 'hook' + capitalized];

    for (var key in data) {
      if (data.hasOwnProperty(key)) {
        var value = data[key];

        if (key.indexOf(NS) === 0) {
          key = key.slice(NS.length);
          key = key.charAt(0).toLowerCase() + key.substring(1);

          if (reserved.indexOf(key) === -1) {
            options[key] = value;
          }
        }
      }
    }

    return options;
  }

  /**
   * Document ready handler and DOM mutation observers. Initializes Carousel components as necessary.
   *
   * @private
   */
  function onDocumentReady() {
    var elements = document.querySelectorAll(selectors.self);
    for (var i = 0; i < elements.length; i++) {
      new Carousel({ element: elements[i], options: readData(elements[i]) });
    }

    var MutationObserver =
      window.MutationObserver ||
      window.WebKitMutationObserver ||
      window.MozMutationObserver;
    var body = document.querySelector('body');
    var observer = new MutationObserver(function (mutations) {
      mutations.forEach(function (mutation) {
        // needed for IE
        var nodesArray = [].slice.call(mutation.addedNodes);
        if (nodesArray.length > 0) {
          nodesArray.forEach(function (addedNode) {
            if (addedNode.querySelectorAll) {
              var elementsArray = [].slice.call(
                addedNode.querySelectorAll(selectors.self)
              );
              elementsArray.forEach(function (element) {
                new Carousel({ element: element, options: readData(element) });
              });
            }
          });
        }
      });
    });

    observer.observe(body, {
      subtree: true,
      childList: true,
      characterData: true,
    });
  }

  if (document.readyState !== 'loading') {
    onDocumentReady();
  } else {
    document.addEventListener('DOMContentLoaded', onDocumentReady);
  }
})();

/*******************************************************************************
 * Copyright 2017 Adobe
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 ******************************************************************************/
if (window.Element && !Element.prototype.closest) {
  // eslint valid-jsdoc: "off"
  Element.prototype.closest = function (s) {
    'use strict';
    var matches = (this.document || this.ownerDocument).querySelectorAll(s);
    var el = this;
    var i;
    do {
      i = matches.length;
      while (--i >= 0 && matches.item(i) !== el) {
        // continue
      }
    } while (i < 0 && (el = el.parentElement));
    return el;
  };
}

if (window.Element && !Element.prototype.matches) {
  Element.prototype.matches =
    Element.prototype.matchesSelector ||
    Element.prototype.mozMatchesSelector ||
    Element.prototype.msMatchesSelector ||
    Element.prototype.oMatchesSelector ||
    Element.prototype.webkitMatchesSelector ||
    function (s) {
      'use strict';
      var matches = (this.document || this.ownerDocument).querySelectorAll(s);
      var i = matches.length;
      while (--i >= 0 && matches.item(i) !== this) {
        // continue
      }
      return i > -1;
    };
}

if (!Object.assign) {
  Object.assign = function (target, varArgs) {
    // .length of function is 2
    'use strict';
    if (target === null) {
      throw new TypeError('Cannot convert undefined or null to object');
    }

    var to = Object(target);

    for (var index = 1; index < arguments.length; index++) {
      var nextSource = arguments[index];

      if (nextSource !== null) {
        for (var nextKey in nextSource) {
          if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {
            to[nextKey] = nextSource[nextKey];
          }
        }
      }
    }
    return to;
  };
}

(function (arr) {
  'use strict';
  arr.forEach(function (item) {
    if (item.hasOwnProperty('remove')) {
      return;
    }
    Object.defineProperty(item, 'remove', {
      configurable: true,
      enumerable: true,
      writable: true,
      value: function remove() {
        this.parentNode.removeChild(this);
      },
    });
  });
})([Element.prototype, CharacterData.prototype, DocumentType.prototype]);

/*******************************************************************************
 * Copyright 2016 Adobe
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 ******************************************************************************/
(function () {
  'use strict';

  var devicePixelRatio = window.devicePixelRatio || 1;

  function SmartImage(noScriptElement, options) {
    var that = this;
    var showsLazyLoader = false;
    var image;
    var container;
    var anchor;
    var dropContainer;
    var initDone = false;

    that.defaults = {
      loadHidden: false,
      imageSelector: 'img',
      containerSelector: '.cmp-image',
      sourceAttribute: 'src',
      lazyEnabled: true,
      lazyThreshold: 0,
      lazyEmptyPixel:
        'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7',
      lazyLoaderClass: 'loading',
      lazyLoaderStyle: {
        height: 0,
        'padding-bottom': '', // will get replaced with ratio in %
      },
    };

    function init() {
      var tmp = document.createElement('div');
      tmp.innerHTML = decodeNoScript(noScriptElement.textContent.trim());
      var imageElement = tmp.firstElementChild;
      var source = imageElement.getAttribute(options.sourceAttribute);
      imageElement.removeAttribute(options.sourceAttribute);
      imageElement.setAttribute('data-src-disabled', source);
      container.insertBefore(imageElement, noScriptElement);
      noScriptElement.remove();

      if (container.matches(options.imageSelector)) {
        image = container;
      } else {
        image = imageElement;
      }

      that.container = container;
      that.options = options;
      that.image = image;
      if (options.lazyEnabled) {
        addLazyLoader();
      }
      window.addEventListener('scroll', that.update);
      window.addEventListener('resize', that.update);
      window.addEventListener('update', that.update);
      image.addEventListener('cmp-image-redraw', that.update);
      that.update();
    }

    function loadImage() {
      if (
        options.smartSizes &&
        options.smartImages &&
        options.smartSizes.length > 0
      ) {
        if (options.smartSizes.length === options.smartImages.length) {
          var containerWidth = 0;

          if (container.tagName.toLowerCase() === 'a') {
            containerWidth = container.parentElement.clientWidth;
          } else {
            containerWidth = container.clientWidth;
          }
          var optimalSize = containerWidth * devicePixelRatio;
          var len = options.smartSizes.length;
          var key = 0;

          while (key < len - 1 && options.smartSizes[key] < optimalSize) {
            key++;
          }

          if (
            image.getAttribute(options.sourceAttribute) !==
            options.smartImages[key]
          ) {
            image.setAttribute(
              options.sourceAttribute,
              options.smartImages[key]
            );
            image.removeAttribute('data-src-disabled');
            window.removeEventListener('scroll', that.update);
          }
        }
      } else {
        if (!initDone) {
          image.setAttribute(
            options.sourceAttribute,
            image.getAttribute('data-src-disabled')
          );
          image.removeAttribute('data-src-disabled');
          window.removeEventListener('scroll', that.update);
          initDone = true;
        }
      }

      if (showsLazyLoader) {
        image.addEventListener('load', removeLazyLoader);
      }
    }

    function addLazyLoader() {
      var width = image.getAttribute('width');
      var height = image.getAttribute('height');
      if (width && height) {
        var ratio = (height / width) * 100;
        var styles = options.lazyLoaderStyle;
        styles['padding-bottom'] = ratio + '%';
        for (var s in styles) {
          if (styles.hasOwnProperty(s)) {
            image.style[s] = styles[s];
          }
        }
      }
      image.setAttribute(options.sourceAttribute, options.lazyEmptyPixel);
      image.classList.add(options.lazyLoaderClass);
      showsLazyLoader = true;
    }

    function removeLazyLoader() {
      image.classList.remove(options.lazyLoaderClass);
      for (var property in options.lazyLoaderStyle) {
        if (options.lazyLoaderStyle.hasOwnProperty(property)) {
          image.style[property] = '';
        }
      }
      image.removeEventListener('load', removeLazyLoader);
      showsLazyLoader = false;
    }

    function isLazyVisible() {
      if (container.offsetParent === null) {
        return false;
      }

      var wt = window.pageYOffset;
      var wb = wt + document.documentElement.clientHeight;
      var et = container.getBoundingClientRect().top + wt;
      var eb = et + container.clientHeight;

      return (
        eb >= wt - options.lazyThreshold && et <= wb + options.lazyThreshold
      );
    }

    that.update = function () {
      if (options.lazyEnabled) {
        if (isLazyVisible() || options.loadHidden) {
          loadImage();
        }
      } else {
        loadImage();
      }
    };

    options = Object.assign(that.defaults, options);

    container = noScriptElement.closest(options.containerSelector);
    if (container) {
      dropContainer = noScriptElement.closest('.cq-dd-image');
      if (dropContainer) {
        container = dropContainer;
      }
      anchor = container.querySelector('.cmp-image--link');
      if (anchor !== null) {
        container = anchor;
      }
      init();
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    var imageElements = document.querySelectorAll('noscript[data-cmp-image]');
    var images = [];
    for (var index = 0; index < imageElements.length; index++) {
      var noScriptElement = imageElements[index];
      var imageOptions = noScriptElement.dataset.cmpImage;
      noScriptElement.removeAttribute('data-cmp-image');
      images.push(new SmartImage(noScriptElement, JSON.parse(imageOptions)));
    }
    var MutationObserver =
      window.MutationObserver ||
      window.WebKitMutationObserver ||
      window.MozMutationObserver;
    var body = document.querySelector('body');
    var observer = new MutationObserver(function (mutations) {
      mutations.forEach(function (mutation) {
        // needed for IE
        var nodesArray = [].slice.call(mutation.addedNodes);
        if (nodesArray.length > 0) {
          nodesArray.forEach(function (addedNode) {
            if (addedNode.querySelectorAll) {
              var noScriptArray = [].slice.call(
                addedNode.querySelectorAll('noscript[data-cmp-image]')
              );
              noScriptArray.forEach(function (noScriptElement) {
                var imageOptions = JSON.parse(noScriptElement.dataset.cmpImage);
                noScriptElement.removeAttribute('data-cmp-image');
                images.push(new SmartImage(noScriptElement, imageOptions));
              });
            }
          });
        }
      });
    });

    observer.observe(body, {
      subtree: true,
      childList: true,
      characterData: true,
    });
  });

  /*
         on drag & drop of the component into a parsys, noscript's content will be escaped multiple times by the editor which creates
         the DOM for editing; the HTML parser cannot be used here due to the multiple escaping
     */
  function decodeNoScript(text) {
    text = text.replace(/&(amp;)*lt;/g, '<');
    text = text.replace(/&(amp;)*gt;/g, '>');
    return text;
  }
})();

/*******************************************************************************
 * Copyright 2017 Adobe
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 ******************************************************************************/
(function () {
  'use strict';

  var NS = 'cmp';
  var IS = 'search';

  var DELAY = 300; // time before fetching new results when the user is typing a search string
  var LOADING_DISPLAY_DELAY = 300; // minimum time during which the loading indicator is displayed
  var PARAM_RESULTS_OFFSET = 'resultsOffset';

  var keyCodes = {
    TAB: 9,
    ENTER: 13,
    ESCAPE: 27,
    ARROW_UP: 38,
    ARROW_DOWN: 40,
  };

  var selectors = {
    self: '[data-' + NS + '-is="' + IS + '"]',
    item: {
      self: '[data-' + NS + '-hook-' + IS + '="item"]',
      title: '[data-' + NS + '-hook-' + IS + '="itemTitle"]',
      focused: '.' + NS + '-search__item--is-focused',
    },
  };

  var properties = {
    /**
     * The minimum required length of the search term before results are fetched.
     *
     * @memberof Search
     * @type {Number}
     * @default 3
     */
    minLength: {
      default: 3,
      transform: function (value) {
        value = parseFloat(value);
        return isNaN(value) ? null : value;
      },
    },
    /**
     * The maximal number of results fetched by a search request.
     *
     * @memberof Search
     * @type {Number}
     * @default 10
     */
    resultsSize: {
      default: 10,
      transform: function (value) {
        value = parseFloat(value);
        return isNaN(value) ? null : value;
      },
    },
  };

  var idCount = 0;

  function readData(element) {
    var data = element.dataset;
    var options = [];
    var capitalized = IS;
    capitalized = capitalized.charAt(0).toUpperCase() + capitalized.slice(1);
    var reserved = ['is', 'hook' + capitalized];

    for (var key in data) {
      if (data.hasOwnProperty(key)) {
        var value = data[key];

        if (key.indexOf(NS) === 0) {
          key = key.slice(NS.length);
          key = key.charAt(0).toLowerCase() + key.substring(1);

          if (reserved.indexOf(key) === -1) {
            options[key] = value;
          }
        }
      }
    }

    return options;
  }

  function toggleShow(element, show) {
    if (element) {
      if (show !== false) {
        element.style.display = 'block';
        element.setAttribute('aria-hidden', false);
      } else {
        element.style.display = 'none';
        element.setAttribute('aria-hidden', true);
      }
    }
  }

  function serialize(form) {
    var query = [];
    if (form && form.elements) {
      for (var i = 0; i < form.elements.length; i++) {
        var node = form.elements[i];
        if (!node.disabled && node.name) {
          var param = [node.name, encodeURIComponent(node.value)];
          query.push(param.join('='));
        }
      }
    }
    return query.join('&');
  }

  function mark(node, regex) {
    if (!node || !regex) {
      return;
    }

    // text nodes
    if (node.nodeType === 3) {
      var nodeValue = node.nodeValue;
      var match = regex.exec(nodeValue);

      if (nodeValue && match) {
        var element = document.createElement('mark');
        element.className = NS + '-search__item-mark';
        element.appendChild(document.createTextNode(match[0]));

        var after = node.splitText(match.index);
        after.nodeValue = after.nodeValue.substring(match[0].length);
        node.parentNode.insertBefore(element, after);
      }
    } else if (node.hasChildNodes()) {
      for (var i = 0; i < node.childNodes.length; i++) {
        // recurse
        mark(node.childNodes[i], regex);
      }
    }
  }

  function Search(config) {
    if (config.element) {
      // prevents multiple initialization
      config.element.removeAttribute('data-' + NS + '-is');
    }

    this._cacheElements(config.element);
    this._setupProperties(config.options);

    this._action = this._elements.form.getAttribute('action');
    this._resultsOffset = 0;
    this._hasMoreResults = true;

    this._elements.input.addEventListener('input', this._onInput.bind(this));
    this._elements.input.addEventListener('focus', this._onInput.bind(this));
    this._elements.input.addEventListener(
      'keydown',
      this._onKeydown.bind(this)
    );
    this._elements.clear.addEventListener(
      'click',
      this._onClearClick.bind(this)
    );
    document.addEventListener('click', this._onDocumentClick.bind(this));
    this._elements.results.addEventListener(
      'scroll',
      this._onScroll.bind(this)
    );

    this._makeAccessible();
  }

  Search.prototype._displayResults = function () {
    if (this._elements.input.value.length === 0) {
      toggleShow(this._elements.clear, false);
      this._cancelResults();
    } else if (this._elements.input.value.length < this._properties.minLength) {
      toggleShow(this._elements.clear, true);
    } else {
      this._updateResults();
      toggleShow(this._elements.clear, true);
    }
  };

  Search.prototype._onScroll = function (event) {
    // fetch new results when the results to be scrolled down are less than the visible results
    if (
      this._elements.results.scrollTop +
        2 * this._elements.results.clientHeight >=
      this._elements.results.scrollHeight
    ) {
      this._resultsOffset += this._properties.resultsSize;
      this._displayResults();
    }
  };

  Search.prototype._onInput = function (event) {
    var self = this;
    self._cancelResults();
    // start searching when the search term reaches the minimum length
    this._timeout = setTimeout(function () {
      self._displayResults();
    }, DELAY);
  };

  Search.prototype._onKeydown = function (event) {
    var self = this;

    switch (event.keyCode) {
      case keyCodes.TAB:
        if (self._resultsOpen()) {
          event.preventDefault();
        }
        break;
      case keyCodes.ENTER:
        event.preventDefault();
        if (self._resultsOpen()) {
          var focused = self._elements.results.querySelector(
            selectors.item.focused
          );
          if (focused) {
            focused.click();
          }
        }
        break;
      case keyCodes.ESCAPE:
        self._cancelResults();
        break;
      case keyCodes.ARROW_UP:
        if (self._resultsOpen()) {
          event.preventDefault();
          self._stepResultFocus(true);
        }
        break;
      case keyCodes.ARROW_DOWN:
        if (self._resultsOpen()) {
          event.preventDefault();
          self._stepResultFocus();
        } else {
          // test the input and if necessary fetch and display the results
          self._onInput();
        }
        break;
      default:
        return;
    }
  };

  Search.prototype._onClearClick = function (event) {
    event.preventDefault();
    this._elements.input.value = '';
    toggleShow(this._elements.clear, false);
    toggleShow(this._elements.results, false);
  };

  Search.prototype._onDocumentClick = function (event) {
    var inputContainsTarget = this._elements.input.contains(event.target);
    var resultsContainTarget = this._elements.results.contains(event.target);

    if (!(inputContainsTarget || resultsContainTarget)) {
      toggleShow(this._elements.results, false);
    }
  };

  Search.prototype._resultsOpen = function () {
    return this._elements.results.style.display !== 'none';
  };

  Search.prototype._makeAccessible = function () {
    var id = NS + '-search-results-' + idCount;
    this._elements.input.setAttribute('aria-owns', id);
    this._elements.results.id = id;
    idCount++;
  };

  Search.prototype._generateItems = function (data, results) {
    var self = this;

    data.forEach(function (item) {
      var el = document.createElement('span');
      el.innerHTML = self._elements.itemTemplate.innerHTML;
      el.querySelectorAll(selectors.item.title)[0].appendChild(
        document.createTextNode(item.title)
      );
      el.querySelectorAll(selectors.item.self)[0].setAttribute(
        'href',
        item.url
      );
      results.innerHTML += el.innerHTML;
    });
  };

  Search.prototype._markResults = function () {
    var nodeList = this._elements.results.querySelectorAll(selectors.item.self);
    var escapedTerm = this._elements.input.value.replace(
      /[-[\]{}()*+?.,\\^$|#\s]/g,
      '\\$&'
    );
    var regex = new RegExp('(' + escapedTerm + ')', 'gi');

    for (var i = this._resultsOffset - 1; i < nodeList.length; ++i) {
      var result = nodeList[i];
      mark(result, regex);
    }
  };

  Search.prototype._stepResultFocus = function (reverse) {
    var results = this._elements.results.querySelectorAll(selectors.item.self);
    var focused = this._elements.results.querySelector(selectors.item.focused);
    var newFocused;
    var index = Array.prototype.indexOf.call(results, focused);
    var focusedCssClass = NS + '-search__item--is-focused';

    if (results.length > 0) {
      if (!reverse) {
        // highlight the next result
        if (index < 0) {
          results[0].classList.add(focusedCssClass);
        } else if (index + 1 < results.length) {
          results[index].classList.remove(focusedCssClass);
          results[index + 1].classList.add(focusedCssClass);
        }

        // if the last visible result is partially hidden, scroll up until it's completely visible
        newFocused = this._elements.results.querySelector(
          selectors.item.focused
        );
        if (newFocused) {
          var bottomHiddenHeight =
            newFocused.offsetTop +
            newFocused.offsetHeight -
            this._elements.results.scrollTop -
            this._elements.results.clientHeight;
          if (bottomHiddenHeight > 0) {
            this._elements.results.scrollTop += bottomHiddenHeight;
          } else {
            this._onScroll();
          }
        }
      } else {
        // highlight the previous result
        if (index >= 1) {
          results[index].classList.remove(focusedCssClass);
          results[index - 1].classList.add(focusedCssClass);
        }

        // if the first visible result is partially hidden, scroll down until it's completely visible
        newFocused = this._elements.results.querySelector(
          selectors.item.focused
        );
        if (newFocused) {
          var topHiddenHeight =
            this._elements.results.scrollTop - newFocused.offsetTop;
          if (topHiddenHeight > 0) {
            this._elements.results.scrollTop -= topHiddenHeight;
          }
        }
      }
    }
  };

  Search.prototype._updateResults = function () {
    var self = this;
    if (self._hasMoreResults) {
      var request = new XMLHttpRequest();
      var url =
        self._action +
        '?' +
        serialize(self._elements.form) +
        '&' +
        PARAM_RESULTS_OFFSET +
        '=' +
        self._resultsOffset;

      request.open('GET', url, true);
      request.onload = function () {
        // when the results are loaded: hide the loading indicator and display the search icon after a minimum period
        setTimeout(function () {
          toggleShow(self._elements.loadingIndicator, false);
          toggleShow(self._elements.icon, true);
        }, LOADING_DISPLAY_DELAY);
        if (request.status >= 200 && request.status < 400) {
          // success status
          var data = JSON.parse(request.responseText);
          if (data.length > 0) {
            self._generateItems(data, self._elements.results);
            self._markResults();
            toggleShow(self._elements.results, true);
          } else {
            self._hasMoreResults = false;
          }
          // the total number of results is not a multiple of the fetched results:
          // -> we reached the end of the query
          if (
            self._elements.results.querySelectorAll(selectors.item.self)
              .length %
              self._properties.resultsSize >
            0
          ) {
            self._hasMoreResults = false;
          }
        } else {
          // error status
        }
      };
      // when the results are loading: display the loading indicator and hide the search icon
      toggleShow(self._elements.loadingIndicator, true);
      toggleShow(self._elements.icon, false);
      request.send();
    }
  };

  Search.prototype._cancelResults = function () {
    clearTimeout(this._timeout);
    this._elements.results.scrollTop = 0;
    this._resultsOffset = 0;
    this._hasMoreResults = true;
    this._elements.results.innerHTML = '';
  };

  Search.prototype._cacheElements = function (wrapper) {
    this._elements = {};
    this._elements.self = wrapper;
    var hooks = this._elements.self.querySelectorAll(
      '[data-' + NS + '-hook-' + IS + ']'
    );

    for (var i = 0; i < hooks.length; i++) {
      var hook = hooks[i];
      var capitalized = IS;
      capitalized = capitalized.charAt(0).toUpperCase() + capitalized.slice(1);
      var key = hook.dataset[NS + 'Hook' + capitalized];
      this._elements[key] = hook;
    }
  };

  Search.prototype._setupProperties = function (options) {
    this._properties = {};

    for (var key in properties) {
      if (properties.hasOwnProperty(key)) {
        var property = properties[key];
        if (options && options[key] != null) {
          if (property && typeof property.transform === 'function') {
            this._properties[key] = property.transform(options[key]);
          } else {
            this._properties[key] = options[key];
          }
        } else {
          this._properties[key] = properties[key]['default'];
        }
      }
    }
  };

  function onDocumentReady() {
    var elements = document.querySelectorAll(selectors.self);
    for (var i = 0; i < elements.length; i++) {
      new Search({ element: elements[i], options: readData(elements[i]) });
    }

    var MutationObserver =
      window.MutationObserver ||
      window.WebKitMutationObserver ||
      window.MozMutationObserver;
    var body = document.querySelector('body');
    var observer = new MutationObserver(function (mutations) {
      mutations.forEach(function (mutation) {
        // needed for IE
        var nodesArray = [].slice.call(mutation.addedNodes);
        if (nodesArray.length > 0) {
          nodesArray.forEach(function (addedNode) {
            if (addedNode.querySelectorAll) {
              var elementsArray = [].slice.call(
                addedNode.querySelectorAll(selectors.self)
              );
              elementsArray.forEach(function (element) {
                new Search({ element: element, options: readData(element) });
              });
            }
          });
        }
      });
    });

    observer.observe(body, {
      subtree: true,
      childList: true,
      characterData: true,
    });
  }

  if (document.readyState !== 'loading') {
    onDocumentReady();
  } else {
    document.addEventListener('DOMContentLoaded', onDocumentReady);
  }
})();

$.widget('gene.formContainer', {
  _create: function () {
    this.$form = this.element.find('form');
    this.id = this.$form.attr('id');
    this.$captchaContainer = this.element.find('.cmp-captcha');
    this.captchaWidgetId;
    this.$thankYouMessage = this.element.find(
      '.cmp-form-container--thank-you-message'
    );
    this.$errorContainer = this.element.find(
      '.cmp-form-container--error-container'
    );
    this.postUrl = this.$form.attr('action');
    this.defaultDateSubmitFormat = 'YYYY-MM-DD';
    this.postApis = this.element.data('post-apis');
    this.forwardUrlHash = this.element.is('[data-forward-url-hash]');
    this.formSchemaModel = this.element.data('form-schema-model');
    this.persistDataInSession = this.element.is('[data-persist-in-session]');
    this.$loadingOverlay = this.element.find('.cmp-loadingoverlay');

    this._initAdditonalValidations();

    this.$form.submit(
      $.proxy(function (event) {
        event.preventDefault();

        if (!this.$form.parsley(GeneCore.utils.form.parsleyOptions).isValid()) {
          return false;
        } else {
          if (this.element.attr('data-navigate-to-page')) {
            this._persistFormDataInSession();

            var navigationUrl = this.element.attr('data-navigate-to-page');
            if (
              this.forwardUrlHash &&
              GeneCore.utils.generalUtils.getUrlHash()
            ) {
              navigationUrl += '#' + GeneCore.utils.generalUtils.getUrlHash();
            }

            window.location.href = navigationUrl;
            return true;
          }

          if (this.$captchaContainer.length) {
            grecaptcha.execute(this.captchaWidgetId);
          } else {
            this._submit();
          }
        }
      }, this)
    );
  },

  _onValidatedHandler: function (formInstance) {
    var ok = formInstance.isValid();
    if (!ok) {
      GeneCore.utils.anchorsUtil.scrollToYPosition(
        this.$form.find('.parsley-error:first').offset().top - 40,
        false
      );
    }
  },

  _initAdditonalValidations: function () {
    //set multiple text inputs with the same name to have parsley equalTo validator
    this.element
      .find(':text, input[type=email], input[type=password]')
      .each(function () {
        var $textInputs = $('[name="' + $(this).attr('name') + '"]');
        if ($textInputs.length > 1) {
          var firstInputId = $textInputs.first().attr('id');
          $textInputs.each(function (index, item) {
            if (index > 0) {
              $(item).attr('data-parsley-equalto', '#' + firstInputId);
              $(item).attr('data-parsley-error-message', 'Fields must match');
            }
          });
        }
      });

    this.$form
      .parsley()
      .on('form:validated', $.proxy(this._onValidatedHandler, this));
  },

  _submit: function (postUrls) {
    this._removeDuplicateTextFieldNames();

    if (!this.formSchemaModel.url) {
      this.$errorContainer.html('Error. Post URL is not configured');
      this._showErrorMessage();
      return;
    }

    var url = this.postUrl;

    var $widget = this;
    this.postToApis('cmp-formcontainer-internal', function (response) {
      $widget._showSuccess();
    });
  },

  _persistFormDataInSession: function () {
    if (this.persistDataInSession) {
      var sessionData = GeneCore.utils.form.getSessionFormData();

      var formData = this._getFormFieldData();
      sessionData[this.id] = formData;
      GeneCore.utils.form.setSessionFormData(sessionData);
    }
  },

  _showSuccess: function () {
    this.$form.hide();
    this.$errorContainer.hide();
    this.$thankYouMessage.removeClass('hidden-publish-view');
    GeneCore.utils.anchorsUtil.scrollToYPosition(
      this.element.offset().top - 10,
      false
    );
  },

  _showErrorMessage: function (response, $widget) {
    var scope;
    if (!this.element && $widget != null) {
      scope = $widget;
    } else {
      scope = this;
    }

    scope.$loadingOverlay.loadingOverlay('hide');

    var errorMessage = 'There was an error submitting the form<br>';
    if (response != null) {
      errorMessage +=
        '<i>' + response.status + ' ' + response.responseText + '</i><br>';
    }
    errorMessage += '<br>Please try again later.';

    scope.$errorContainer.html(errorMessage);
    scope.$errorContainer.fadeIn();
    GeneCore.utils.anchorsUtil.scrollToYPosition(
      scope.$errorContainer.offset().top - 40,
      false
    );
  },

  postToApis: function (apiIds, successCallback) {
    this._persistFormDataInSession();

    this.$errorContainer.hide();

    var ids = String(apiIds).split(',');
    var deferreds = [];
    var resultsArray = [];

    var $widget = this;

    this.$loadingOverlay.loadingOverlay('show');
    for (index in ids) {
      var api = this.postApis.find(function (x) {
        return x.apiLocalId == ids[index];
      });

      var url = api.url;
      if (api.forwardMocValue && api.forwardMocValue == 'true') {
        var mocValue = GeneCore.utils.cookieUtils.getCookie('moc');
        if (mocValue) {
          url = GeneCore.utils.generalUtils.addUrlParam(
            this.postUrl,
            'c=' + mocValue
          );
        }
      }

      var payloadTemplate = api.payloadTemplate;
      var postData;

      var data = this._getFormFieldData(api);

      if (payloadTemplate !== undefined && payloadTemplate.length) {
        data['formSessionData'] = GeneCore.utils.form.getSessionFormData();
        var template = Handlebars.compile(payloadTemplate);
        var templateOutput = template(data);
        postData = JSON.parse(templateOutput);
      } else {
        postData = data;
      }

      postData = this._mergeComponentData(postData);
      postData = GeneCore.utils.generalUtils.filterNullOrEmpty(postData);
      postData = this._applyTransformations(postData, api);

      if (payloadTemplate !== undefined && payloadTemplate.length) {
        postData = JSON.stringify(postData, null, '\t');
      }

      var $widget = this;

      if (url) {
        var requestPromise = $.Deferred();
        deferreds.push(requestPromise);

        if (api.tokenServiceUrl == null) {
          this._postDataToUrl(
            postData,
            url,
            requestPromise,
            $widget._showErrorMessage,
            resultsArray
          );
        } else {
          $.ajax({
            type: 'GET',
            url: api.tokenServiceUrl,
            indexValue: index,
            success: function (response) {
              requestHeadersArray = response;
              $widget._postDataToUrl(
                postData,
                url,
                deferreds[this.indexValue],
                $widget._showErrorMessage,
                resultsArray,
                requestHeadersArray
              );
            },
            error: function (response) {
              $widget._showErrorMessage(response, $widget);
            },
          });
        }
      }
    }
    $.when.apply(null, deferreds).done(function () {
      $widget.element.data('response-data', resultsArray);

      if ($widget.element.find('.cmp-dynamicresult').length) {
        $widget.element
          .find('.cmp-dynamicresult')
          .dynamicResult('render', resultsArray);
      }

      $widget.$loadingOverlay.loadingOverlay('hide');
      successCallback(resultsArray);
    });
  },

  _postDataToUrl: function (
    data,
    url,
    successCallback,
    errorCallback,
    resultsArray,
    requestHeadersArray
  ) {
    console.log('_postDataToUrl: ' + url);
    console.log(data);
    var $widget = this;
    $.ajax({
      url: url,
      data: data,
      type: 'POST',
      beforeSend: function (xhr) {
        for (var key in requestHeadersArray) {
          xhr.setRequestHeader(key, requestHeadersArray[key]);
        }
      },
      success: function (response) {
        if (resultsArray != undefined && Array.isArray(resultsArray)) {
          resultsArray.push(response);
        }

        if (successCallback && successCallback.then != undefined) {
          successCallback.resolve(response);
        } else if (typeof successCallback == 'function') {
          successCallback(response);
        }
      },
      error: function (response) {
        if (successCallback && successCallback.then != undefined) {
          successCallback.reject(response);
        }

        if (typeof errorCallback == 'function') {
          errorCallback(response, $widget);
        }
      },
    });
  },

  _removeDuplicateTextFieldNames: function () {
    //We may have fields where the user has two enter an email/password twice to confirm.
    //Here we remove the name from all but the last input to prevent array submission.
    this.element
      .find(':text, input[type=email], input[type=password]')
      .not('.serialize-ignore input')
      .each(function () {
        var $textInputs = $('[name="' + $(this).attr('name') + '"]');
        if ($textInputs.length > 1) {
          $textInputs.each(function (index, item) {
            if (index < $textInputs.length - 1) {
              $(item).attr('name', '');
            }
          });
        }
      });
  },
  _getFormFieldData: function (api) {
    var fieldsToIgnore = [
      '.serialize-ignore input',
      '.serialize-ignore select',
      '.hidden-by-form-rule input',
      '.hidden-by-form-rule select',
    ];
    var fieldsToSerialize = this.$form.find('input,select').not(fieldsToIgnore);
    // Find inputs disabled by same-as checkbox, and remove the "disabled" attribute
    var disabled = this.$form
      .find('[data-disabled-by-sameas-checkbox]')
      .removeAttr('disabled');
    var data = fieldsToSerialize.serializeObject();
    // re-disabled the set of inputs
    disabled.attr('disabled', true);

    data = this._setDataFormats(data, api);

    return data;
  },
  _mergeComponentData: function (data) {
    this.$form
      .find('.cmp-contactinfo')
      .not('.hidden-by-form-rule .cmp-contactinfo')
      .each(function () {
        data = $(this).contactInfo('getData', data);
      });

    if (this.$captchaContainer.length) {
      var recaptchaResponse = grecaptcha.getResponse(this.captchaWidgetId);
      var captchaObject = {
        challenge: 'DEPRECATED',
        response: recaptchaResponse || data['g-recaptcha-response'] || '',
      };
      data.captcha = captchaObject;
      delete data['g-recaptcha-response'];
    }

    return data;
  },
  _setDataFormats: function (data, api) {
    if (api && api.picardDataFormatting == 'true') {
      data['picard-api-version'] = 'V2';
    }

    for (var key in data) {
      var $inputs = this.$form.find('[name="' + key + '"]');

      if (api && api.picardDataFormatting == 'true' && !data[key].push) {
        //Picard schema expects fields which can submit multiple values to submit in array format,
        //even if only one value is selected. This will convert single values to an array prior to post
        if ($inputs.first().data('is-array') !== undefined) {
          data[key] = [data[key]];
        }
      }

      //format dates for backend
      if (
        $inputs.first().attr('type') == 'date' ||
        $inputs.first().hasClass('flatpickr-input')
      ) {
        var dateSubmitFormat =
          $inputs.first().data('date-submit-format') ||
          this.defaultDateSubmitFormat;

        var dateValue = $inputs.first().val();
        if (dateValue != '') {
          dateValue = moment(dateValue, 'MM/DD/YYYY').format(dateSubmitFormat);
          data[key] = dateValue;
        }
      }
    }
    return data;
  },
  _applyTransformations: function (data, api) {
    if (api.connectiveRxDataProcessing) {
      data = GeneCore.ConnectiveRx.transformData(data);
    }
    return data;
  },

  initRecaptcha: function () {
    if (this.$captchaContainer.length) {
      this.captchaWidgetId = grecaptcha.render(
        this.$captchaContainer.attr('id'),
        {
          sitekey: this.$captchaContainer.data('sitekey'),
          size: 'invisible',
          badge: 'inline',
          callback: $.proxy(this._submit, this),
        }
      );
    }
  },
});

var recaptchaReady;
(function ($) {
  $('.cmp-form-container').formContainer();

  recaptchaReady = function () {
    $('.cmp-form-container').each(function () {
      $(this).formContainer('initRecaptcha');
    });
  };
})(jQuery);

$.widget('gene.formRules', {
  _create: function () {
    this.debugModeEnabled = GeneCore.utils.generalUtils.getUrlParam(
      'formDebugMode'
    )
      ? true
      : false;
    this.$formContainer = this.element;
    this.isEditMode = this.$formContainer.is('[data-is-edit-mode]');

    this.$rulesets = this.$formContainer.find('.cmp-ruleset');
    this.rulesets = [];
    this.formId = this.element.attr('id');
    this.inputsWithConditionsApplied = [];

    this.fieldsDisabledByDefault = this.$formContainer.find('[disabled=true]');
    this.fieldsEnabledByDefault = this.$formContainer.find(
      'input:enabled,.cmp-form-button:enabled,select:enabled'
    );

    this.fieldsHiddenByDefault = this.$formContainer.find(
      '[data-hideable-hook].hidden-by-form-rule'
    );
    this.fieldsShownByDefault = this.$formContainer.find(
      '[data-hideable-hook]:not(.hidden-by-form-rule)'
    );

    this.formNavigationPathDefault =
      this.$formContainer.data('navigate-to-page');

    this.keepAnswersOnBackButton = this.$formContainer.data(
      'keep-answers-on-back-button'
    )
      ? true
      : false;
    this.applyRulesToHiddenFields = this.$formContainer.data(
      'apply-rules-to-hidden-fields'
    )
      ? true
      : false;
    this._clearInputsIfBackButton();

    this.formResponseData = [];
    this.sessionFormData = GeneCore.utils.form.getSessionFormData();

    //add Ruleset component rulesets into array
    this.rulesets = this.rulesets.concat(this.element.data('rulesets'));
    //add Options component rulesets into array
    this.$formContainer.find('[data-ruleset-list]').each(
      $.proxy(function (index, el) {
        var inputRules = $(el).data('ruleset-list');
        if (inputRules.length) {
          this.rulesets = this.rulesets.concat(inputRules);
        }
      }, this)
    );

    this.$rulesets = $(this.rulesets);

    this._initOnChangeEventList();

    //Check rules on first load
    this._checkRules();
    $(window).trigger('scroll');
  },

  applyAllRulesets: function () {
    this.formResponseData = this.$formContainer.data('response-data');

    this.previousHtmlState = null;
    var loopCount = 0;
    var maxLoops = 30;

    //Since we ignore values of hidden fields in checkFormCondition, when we show or hide new
    //fields different rulesets may become applicable. Repeat checkRules until no new
    //HTML changes are seen.
    while (
      this.previousHtmlState != this.$formContainer.html() &&
      loopCount < maxLoops
    ) {
      this.previousHtmlState = this.$formContainer.html();
      this._checkRules();
      loopCount++;
    }
    if (loopCount == maxLoops) {
      this._errorMessage(
        'Rulesets resulted in possibly infinite logic loop.' +
          'Stopping after ' +
          maxLoops +
          ' repititions'
      );
      return;
    }
    $(window).trigger('scroll');
  },

  _checkRules: function () {
    this.fieldsToShow = [];
    this.fieldsToHide = [];
    this.fieldsToEnable = [];
    this.fieldsToDisable = [];
    this.rulesetFormNavigationPath = null;

    this.booleanLogicString;

    this.$rulesets.each(
      $.proxy(function (index, ruleset) {
        this._debugMessage('============================');
        this.booleanLogicString = '';
        $(ruleset.formConditions).each(
          $.proxy(function (index, formCondition) {
            var isConditionTrue;
            if (formCondition.conditionCategory == 'dataCondition') {
              isConditionTrue = this._checkDataCondition(formCondition);
            } else {
              isConditionTrue = this._checkFormCondition(formCondition);
            }
            this.booleanLogicString += ' ' + isConditionTrue + ' ';
            this.booleanLogicString += formCondition.operator || '';
          }, this)
        );

        this._debugMessage(ruleset);
        if (this._evaluateFunctionString(this.booleanLogicString)) {
          this._debugMessage(
            'Ruleset evaluated TRUE after evaluating: ' +
              this.booleanLogicString
          );

          this._applyActions(ruleset.formActionGroup);
        } else {
          this._debugMessage(
            'Ruleset evaluated FALSE after evaluating: ' +
              this.booleanLogicString
          );
        }
      }, this)
    );
    this._debugMessage(
      '++++++++++++++++++++++++\n++++++++++++++++++++++++\n++++++++++++++++++++++++'
    );

    this._updateDomStates();
  },

  _checkFormCondition: function (formCondition) {
    var $selectedField = $(
      GeneCore.utils.form.findInput(
        formCondition.fieldSelect,
        this.$formContainer
      )
    );
    var selectedFieldValues = this._getSelectedValueArray($selectedField);

    //if this is a number comparison condition, convert input value to number
    var selectedNumberValue = false;
    if (
      formCondition.numberValue &&
      selectedFieldValues.length &&
      selectedFieldValues[0] != null
    ) {
      selectedNumberValue = Number(selectedFieldValues[0]);
    }

    var isConditionTrue = false;

    switch (formCondition.logicSelect) {
      case 'is':
      case 'not':
        if (!formCondition.ownValues) {
          //rule has no values to check against
          break;
        }
        if (
          _.intersection(selectedFieldValues, formCondition.ownValues).length
        ) {
          isConditionTrue = true;
        }
        //check for cases where we're looking for "empty" value
        if (
          !isConditionTrue &&
          formCondition.ownValues &&
          formCondition.ownValues.indexOf('formrule-empty') > -1
        ) {
          if (selectedFieldValues.length == 1 && selectedFieldValues == '') {
            //field is a Text component and is empty
            isConditionTrue = true;
          } else if (
            selectedFieldValues.includes('empty') ||
            selectedFieldValues.length == 0
          ) {
            //field is an Options component and is empty
            isConditionTrue = true;
          }
        }
        //check for cases where we're looking for "valid" value
        if (
          !isConditionTrue &&
          formCondition.ownValues &&
          formCondition.ownValues.indexOf('formrule-valid') > -1
        ) {
          var $fieldToValidate = $selectedField.length
            ? $($selectedField.get(0))
            : $selectedField;
          if ($fieldToValidate.parsley().isValid()) {
            isConditionTrue = true;
          }
        }
        if (formCondition.logicSelect == 'not') {
          //apply inverse result
          isConditionTrue = !isConditionTrue;
        }
        break;
      case '<':
        if (
          selectedNumberValue != false &&
          selectedNumberValue < formCondition.numberValue
        ) {
          isConditionTrue = true;
        }
        break;
      case '<=':
        if (
          selectedNumberValue != false &&
          selectedNumberValue <= formCondition.numberValue
        ) {
          isConditionTrue = true;
        }
        break;
      case '>':
        if (
          selectedNumberValue != false &&
          selectedNumberValue > formCondition.numberValue
        ) {
          isConditionTrue = true;
        }
        break;
      case '>=':
        if (
          selectedNumberValue != false &&
          selectedNumberValue >= formCondition.numberValue
        ) {
          isConditionTrue = true;
        }
        break;
      default:
        this._errorMessage(
          'formCondition.logicSelect: ' +
            formCondition.logicSelect +
            ' is invalid'
        );
    }
    if (selectedNumberValue) {
      this._debugMessage(
        'selectedNumberValue: ' +
          selectedNumberValue +
          ' ' +
          formCondition.logicSelect +
          ' ' +
          formCondition.numberValue
      );
    }

    return isConditionTrue;
  },

  _checkDataCondition: function (formCondition) {
    isConditionTrue = false;
    switch (formCondition.dataConditionType) {
      case 'response-data':
      case 'session-data':
        var dataToCheck;
        if (formCondition.dataConditionType == 'response-data') {
          dataToCheck = this.formResponseData;
        } else {
          dataToCheck = this.sessionFormData;
        }

        if (formCondition.dataLogicSelect == 'exists') {
          if (
            GeneCore.utils.form.getDataValueFromKey(
              dataToCheck,
              formCondition.dataName
            )
          ) {
            isConditionTrue = true;
          }
          break;
        }
        if (formCondition.dataLogicSelect == 'doesntExist') {
          if (
            !GeneCore.utils.form.getDataValueFromKey(
              dataToCheck,
              formCondition.dataName
            )
          ) {
            isConditionTrue = true;
          }
          break;
        }
        if (formCondition.dataLogicSelect == 'equals') {
          if (
            GeneCore.utils.form.checkForDataValue(
              dataToCheck,
              formCondition.dataName,
              formCondition.dataValue
            )
          ) {
            isConditionTrue = true;
          }
          break;
        }
        if (formCondition.dataLogicSelect == 'notEquals') {
          if (
            !GeneCore.utils.form.checkForDataValue(
              dataToCheck,
              formCondition.dataName,
              formCondition.dataValue
            )
          ) {
            isConditionTrue = true;
          }
          break;
        }

        break;
      case 'url-selector':
        if (formCondition.isUrlSelectorPresent) {
          isConditionTrue = true;
        }
        break;
      default:
        this._errorMessage(
          'formCondition.logicSelect: ' +
            formCondition.logicSelect +
            ' is invalid'
        );
    }
    return isConditionTrue;
  },

  _evaluateFunctionString: function (stringToEvaluate) {
    if (stringToEvaluate.length) {
      return Function('"use strict";return (' + stringToEvaluate + ')')();
    } else {
      return false;
    }
  },

  _applyActions: function (formActionGroup) {
    if (formActionGroup == null) {
      return;
    }

    $(formActionGroup.hideShowActions).each(
      $.proxy(function (index, hideShowAction) {
        if (hideShowAction.actionType == 'show') {
          $(hideShowAction.actionTargets).each(
            $.proxy(function (index, actionTarget) {
              this.fieldsToShow = this.fieldsToShow.concat(
                this._findHideableElement(actionTarget)
              );
            }, this)
          );
        }
        if (hideShowAction.actionType == 'hide') {
          $(hideShowAction.actionTargets).each(
            $.proxy(function (index, actionTarget) {
              this.fieldsToHide = this.fieldsToHide.concat(
                this._findHideableElement(actionTarget)
              );
            }, this)
          );
        }

        if (hideShowAction.actionType == 'enable') {
          $(hideShowAction.actionTargets).each(
            $.proxy(function (index, actionTarget) {
              this.fieldsToEnable = this.fieldsToEnable.concat(
                GeneCore.utils.form.findInput(actionTarget, this.$formContainer)
              );
            }, this)
          );
        }
        if (hideShowAction.actionType == 'disable') {
          $(hideShowAction.actionTargets).each(
            $.proxy(function (index, actionTarget) {
              this.fieldsToDisable = this.fieldsToDisable.concat(
                GeneCore.utils.form.findInput(actionTarget, this.$formContainer)
              );
            }, this)
          );
        }

        if (hideShowAction.actionType == 'set-input-value') {
          $(hideShowAction.actionTargets).each(
            $.proxy(function (index, actionTarget) {
              var fieldArray = GeneCore.utils.form.findInput(
                actionTarget,
                this.$formContainer
              );
              $(fieldArray).each(
                $.proxy(function (index, actionTarget) {
                  $target = $(actionTarget);
                  $target.val(hideShowAction.actionValue);
                }, this)
              );
            }, this)
          );
        }
      }, this)
    );

    if (formActionGroup.formNavigationPath) {
      this.rulesetFormNavigationPath = formActionGroup.formNavigationPath;
    }

    if (formActionGroup.redirectToUrl && !this.isEditMode) {
      window.location.href = formActionGroup.redirectToUrl;
    }
  },

  _updateDomStates: function () {
    //Add items which are DISABLED by default to fieldsToDisable array
    this.fieldsToDisable = _.union(
      this.fieldsToDisable,
      this.fieldsDisabledByDefault
    );

    //Remove fields which are about to be ENABLED by rules
    this.fieldsToDisable = _.difference(
      this.fieldsToDisable,
      this.fieldsToEnable
    );

    //Perform DISABLE operations
    $(this.fieldsToDisable).each(
      $.proxy(function (index, actionTarget) {
        $(actionTarget)
          .prop('disabled', true)
          .trigger('formrule-callback', ['disable']);
      }, this)
    );

    //Add items which are ENABLED by default and not DISABLED by rules
    this.fieldsToEnable = this.fieldsToEnable.concat(
      _.difference(this.fieldsEnabledByDefault, this.fieldsToDisable)
    );
    //ENABLE items per rules
    $(this.fieldsToEnable).each(
      $.proxy(function (index, actionTarget) {
        $target = $(actionTarget);
        if (!$target.data('disabled-by-sameas-checkbox')) {
          $target
            .prop('disabled', false)
            .trigger('formrule-callback', ['enable']);
        }
      }, this)
    );

    //Add items which are HIDDEN by default to fieldsToHide array
    this.fieldsToHide = _.union(this.fieldsToHide, this.fieldsHiddenByDefault);

    //Remove fields which are about to be SHOWN by rules
    this.fieldsToHide = _.difference(this.fieldsToHide, this.fieldsToShow);

    //Perform HIDE operations
    $(this.fieldsToHide).each(
      $.proxy(function (index, actionTarget) {
        $(actionTarget)
          .addClass('hidden-by-form-rule')
          .trigger('formrule-callback', ['hide']);
      }, this)
    );

    //Add items which are SHOWN by default and not HIDDEN by rules
    this.fieldsToShow = this.fieldsToShow.concat(
      _.difference(this.fieldsShownByDefault, this.fieldsToHide)
    );
    //Perform SHOW operations
    $(this.fieldsToShow).each(
      $.proxy(function (index, actionTarget) {
        $(actionTarget)
          .removeClass('hidden-by-form-rule')
          .trigger('formrule-callback', ['show']);
      }, this)
    );

    //Handle other actions
    this.$formContainer.attr(
      'data-navigate-to-page',
      this.rulesetFormNavigationPath || this.formNavigationPathDefault || ''
    );
  },

  _findHideableElement: function (fieldIdentifier) {
    var inputArray = GeneCore.utils.form.findInput(
      fieldIdentifier,
      this.$formContainer
    );
    var $hideableElement;

    if (inputArray.length) {
      $hideableElement = $(inputArray[0]).closest('[data-hideable-hook]');
      return $hideableElement.toArray();
    } else {
      return null;
    }
  },

  _initOnChangeEventList: function () {
    //Find inputs which are monitored by ruleset conditions
    this.$rulesets.each(
      $.proxy(function (index, ruleset) {
        $(ruleset.formConditions).each(
          $.proxy(function (index, formCondition) {
            var returnedValue = GeneCore.utils.form.findInput(
              formCondition.fieldSelect,
              this.$formContainer
            );
            this.inputsWithConditionsApplied =
              this.inputsWithConditionsApplied.concat(returnedValue);
          }, this)
        );
      }, this)
    );
    //remove duplicates
    jQuery.uniqueSort(this.inputsWithConditionsApplied);

    //Init onchange event handlers
    $(this.inputsWithConditionsApplied)
      .filter('[data-evaluate-rules-on-keyup]')
      .keyup(_.throttle($.proxy(this.applyAllRulesets, this), 150));
    $(this.inputsWithConditionsApplied).change(
      $.proxy(this.applyAllRulesets, this)
    );
  },

  _getSelectedValueArray: function ($input) {
    var valueArray = [];

    if (!this.applyRulesToHiddenFields && !$input.is(':visible')) {
      //treat hidden inputs as empty for rule processing purposes
      return valueArray;
    }

    if ($input.is(':checkbox,:radio')) {
      valueArray = $input
        .filter(':checked')
        .map(function () {
          return $(this).val();
        })
        .get();
    } else if ($input.prop('multiple')) {
      valueArray = $input.val();
    } else if ($input.val() != null) {
      valueArray.push($input.val());
    }

    return valueArray;
  },

  _clearInputsIfBackButton: function () {
    $(window).bind(
      'pageshow',
      $.proxy(function (index, el) {
        if (performance.navigation.type == 2) {
          if (!this.keepAnswersOnBackButton) {
            this._clearInputs();
          } else {
            this.applyAllRulesets();
          }
        }
      }, this)
    );
  },

  _clearInputs: function () {
    var $formInputs = this.$formContainer.find('input:not([type=hidden]');
    $formInputs.filter('[type="text"]').val();
    $formInputs.filter('[type="radio"]').prop('checked', false);

    var $selectInputs = this.$formContainer.find('select');
    $selectInputs.prop('selectedIndex', 0);
  },

  _errorMessage: function (message) {
    console.error(message);
  },

  _debugMessage: function (message) {
    if (this.debugModeEnabled) {
      console.log(message);
    }
  },
});

(function ($) {
  //Initialize visibility rules for form fields widgets
  //  $('.cmp-form-container','.cmp-discussionguide').formRules();
  $('.cmp-discussionguide').formRules();
  $('.cmp-form-container').formRules();
})(jQuery);

$.widget('gene.paginationContainer', {
  options: {
    disableNextUntilPageValid: false,
    disableScrollAnimation: true,
  },
  _create: function () {
    this.parsleyOptions = {
      excluded:
        'input[type=button], input[type=submit], input[type=reset], input[type=hidden], [disabled], :hidden',
    };
    this.$formContainer = this.element;
    this.$form = this.element.find('form');
    this.$pages = this.element.find('.pagination-page');
    this.$inputs = this.element.find('input, select');
    this.$progress = this.element.find('.progress');
    this.$progressSteps = this.element.find('.progress__step');

    this.$previousButton = this.element.find('.pagination-buttons__previous');
    this.$nextButton = this.element.find('.pagination-buttons__next');
    this.$submitButton = this.element.find('.pagination-buttons__submit');

    this.options.disableNextUntilPageValid = this.element
      .find('.cmp-pagination')
      .data('disable-next-until-valid');

    if (this.options.disableNextUntilPageValid) {
      this.$nextButton.prop('disabled', true);
      this.$submitButton.prop('disabled', true);

      this.$inputs.on(
        'input',
        $.proxy(function () {
          this._areVisibileInputsValid();
        }, this)
      );
    }

    this.$nextButton.click(
      $.proxy(function (e) {
        if (!this.$form.parsley(this.parsleyOptions).validate()) {
          return false;
        } else {
          this._moveToNextPage();
        }
      }, this)
    );

    this.$previousButton.click(
      $.proxy(function (e) {
        this.currentIndex--;
        this._setPageView(true);
      }, this)
    );

    this.$submitButton.click(
      $.proxy(function (e) {
        //If page has APIs associated with, intercept submit click and
        //call formcontainer method
        if (this.$pages.eq(this.currentIndex).data('post-api-ids')) {
          event.preventDefault();
          if (!this.$form.parsley(this.parsleyOptions).validate()) {
            return false;
          }
          var postUrls = this.$pages.eq(this.currentIndex).data('post-api-ids');
          var $pagination = this;
          this.$formContainer.formContainer(
            'postToApis',
            postUrls,
            function (response) {
              $pagination._moveToNextPage();
            }
          );
        }
      }, this)
    );

    this.currentIndex = 0;

    this._setPageView();
  },
  _moveToNextPage: function () {
    this.currentIndex++;
    this._setPageView(true);
  },
  _setPageView: function (isChangingPage) {
    var $previousPage = this.$pages.eq(this.currentIndex - 1);
    if (this.currentIndex > 0 && !$previousPage.data('post-api-ids')) {
      this.$previousButton.removeClass('hidden');
    } else {
      this.$previousButton.addClass('hidden');
    }
    if (
      this.$pages.eq(this.currentIndex).data('post-api-ids') ||
      this.currentIndex == this.$pages.length - 1
    ) {
      this.$nextButton.addClass('hidden');
      this.$submitButton.removeClass('hidden');
    } else {
      this.$submitButton.addClass('hidden');
      if (this.currentIndex < this.$pages.length - 1) {
        this.$nextButton.removeClass('hidden');
      }
    }
    this.$pages.addClass('hidden-publish-view');
    this.$pages.eq(this.currentIndex).removeClass('hidden-publish-view');

    this.$progressSteps.removeClass('progress__step--active');
    this.$progressSteps
      .eq(this.currentIndex)
      .addClass('progress__step--active');

    this._areVisibileInputsValid();
    if (isChangingPage) {
      this.$formContainer.formRules('applyAllRulesets');
      this._scrollToTop();
    }
  },
  _areVisibileInputsValid: function () {
    var isValid = this.$form.parsley(this.parsleyOptions).isValid();

    if (isValid) {
      this.$nextButton.prop('disabled', false);
      this.$submitButton.prop('disabled', false);
    } else if (this.options.disableNextUntilPageValid) {
      this.$nextButton.prop('disabled', true);
      this.$submitButton.prop('disabled', true);
    }
    return isValid;
  },
  _scrollToTop: function () {
    GeneCore.utils.anchorsUtil.scrollToYPosition(
      this.$progress.offset().top,
      this.options.disableScrollAnimation
    );
  },
});

(function ($) {
  $('.pagination-container').paginationContainer();
})(jQuery);

if (typeof GeneCore === 'undefined') {
  var GeneCore = {};
}

GeneCore.ConnectiveRx = {
  transformData: function (data) {
    var isCareGiverFlow =
      _.get(data, 'enrollment.patient.enrolledByBf') == 2 ||
      _.get(data, 'enrollment.patient.enrolledByBf') == 6;
    if (isCareGiverFlow) {
      var careGiverPreferredContactMethod = _.get(
        data,
        'enrollment.patient.careGiver.preferredContactMethod'
      );
      if (careGiverPreferredContactMethod) {
        data.enrollment.patient.preferredContactMethod =
          careGiverPreferredContactMethod;
      }

      var careGiverEmail = _.get(data, 'enrollment.patient.careGiver.email');
      if (careGiverEmail) {
        data.enrollment.patient.email = careGiverEmail;
      }

      var careGiverContactPoints = _.get(
        data,
        'enrollment.patient.careGiver.contactPoints'
      );
      if (careGiverContactPoints) {
        data.enrollment.patient.contactPoints =
          data.enrollment.patient.contactPoints.concat(careGiverContactPoints);
      }
    }
    return data;
  },
};

(function ($) {
  //Initialize date picker widgets
  $('.cmp-form-text input').each(function () {
    var flatPicker;

    var $input = $(this),
      validateImmediately = $input.data('validate-immeditely');

    if (!$input.is('[data-is-date]')) {
      if (validateImmediately) {
        $input.blur(function () {
          if (!$input.parsley().isValid()) {
            $input.parsley().validate();
          }
        });
      }
    } else {
      options = {
        dateFormat: 'm/d/Y',
        disableMobile: true,
        allowInput: true,
        onClose: function (selectedDates, dateStr, instance) {
          if (validateImmediately) {
            if (!$input.parsley().isValid()) {
              $input.parsley().validate();
            }
          }
        },
      };

      var dateRestriction = $(this).data('date-restriction');
      if (dateRestriction == 'future-only') {
        options.minDate = 'today';
      } else if (dateRestriction == 'past-only') {
        options.maxDate = 'today';
      }

      flatPicker = $(this).flatpickr(options);

      $input.blur(function () {
        if ($input.parsley().isValid()) {
          flatPicker.setDate($(this).val(), true);
        }
      });
    }
  });
})(jQuery);

window.Parsley.addValidator('dateMath', {
  validateString: function (_value, dateMathObject, parsleyInstance) {
    var passesCheck = false;
    var beforeOrAfterPassesCheck = false;

    var $element = parsleyInstance.$element;
    var dateValue = moment(_value, 'MM/DD/YYYY');
    var dateToCompare;

    if (!dateMathObject.fromDate) {
      dateToCompare = new Date();
      dateToCompare.setHours(0, 0, 0, 0);
    } else {
      dateToCompare = moment(dateMathObject.fromDate, 'MM/DD/YYYY');
    }

    var difference = dateValue.diff(dateToCompare, dateMathObject.timeUnit);

    switch (dateMathObject.timePeriod) {
      case 'before':
        if (difference <= 0) {
          beforeOrAfterPassesCheck = true;
          break;
        }
        break;
      case 'after':
        if (difference >= 0) {
          beforeOrAfterPassesCheck = true;
          break;
        }
        break;
      default:
        beforeOrAfterPassesCheck = true;
        break;
    }

    if (beforeOrAfterPassesCheck) {
      difference = Math.abs(difference);
      var comparisonString =
        difference + dateMathObject.operator + dateMathObject.number;
      passesCheck = eval(comparisonString);
    }

    if (passesCheck) {
      return true;
    } else {
      return $.Deferred().reject($element.data('parsley-date-message'));
    }
  },
  requirementType: 'integer',
  messages: {
    en: 'This date does not meet the requirements.',
  },
});

$.widget('gene.masthead', {
  _create: function () {
    //this.element and this.options are available here
    this.$menuButton = this.element.find('.cmp-masthead__menu-button');
    this.$menuContainer = this.element.find('.cmp-masthead__menu');
    this.$mobileLinks = this.element.find(
      '.cmp-masthead__utility-nav-mobile-item, .cmp-masthead__primary-nav__item:not(.cmp-masthead__primary-nav__item--dropdown)'
    );
    this.isMenuOpened = false;

    this.dropdownLinksEnabled = this.element
      .find('.cmp-masthead__primary-nav')
      .data('optionDropdownLinksEnabled');

    this.$menuButton.on('click', $.proxy(this.toggleMenu, this));
    //CORE-829
    this.$mobileLinks.on('click', $.proxy(this.toggleMenu, this));

    // Search button
    this.$searchButton = this.element.find('.cmp-masthead__search-button');
    this.$searchCloseButton = this.element.find('.button-search-close');
    this.$searchContainer = this.element.find(
      '.cmp-masthead__searchinput-mobile-container'
    );
    this.isSearchOpened = false;

    this.$searchButton.on('click', $.proxy(this.toggleSearch, this));
    this.$searchCloseButton.on('click', $.proxy(this.toggleSearch, this));

    this.$dropdownButton = this.element.find(
      '.cmp-masthead__primary-nav-dropdown-button'
    );
    this.$dropdownButtonIcon = this.element.find(
      '.cmp-masthead__primary-nav-dropdown-button i'
    );
    this.$dropdownButtonContainer = this.element.find(
      '.cmp-masthead__primary-nav__item--dropdown'
    );
    this.$dropdownContent = this.element.find(
      '.cmp-masthead__primary-nav-dropdown-content'
    );

    this.scrollPosition = 0;

    $(window).on('breakpoint-change', $.proxy(this.refresh, this));
  },

  toggleDropdownContent: function ($buttonElement) {
    var $dropdownContent = $buttonElement
      .closest('.cmp-masthead__primary-nav__item')
      .find('.cmp-masthead__primary-nav-dropdown-content');
    $dropdownContent.slideToggle('fast');

    if ($buttonElement.hasClass('cmp-masthead__primary-nav-item--open')) {
      $buttonElement.removeClass('cmp-masthead__primary-nav-item--open');
      $(document).off('mouseup.navItem');
    } else {
      $buttonElement.addClass('cmp-masthead__primary-nav-item--open');

      var _this = this;
      var $container = $buttonElement.closest(
        '.cmp-masthead__primary-nav-dropdown'
      );

      $(document).on('mouseup.navItem', function (e) {
        if (
          !$container.is(e.target) && // if the target of the click isn't the container...
          $container.has(e.target).length === 0
        ) {
          // ... nor a descendant of the container
          $dropdownContent.slideToggle('fast');
          $buttonElement.removeClass('cmp-masthead__primary-nav-item--open');

          $(document).off('mouseup.navItem');
        }
      });
    }
  },

  refresh: function (e, breakpoint) {
    if (breakpoint == 'lg') {
      this.$menuContainer.show();
      this.$menuContainer.removeClass('cmp-masthead__menu--open');

      if (this.dropdownLinksEnabled) {
        this.$dropdownButtonIcon.off('click');
      } else {
        this.$dropdownButton.off('click');
      }

      this.$dropdownButton.removeClass('cmp-masthead__primary-nav-item--open');

      $(document).off('mouseup.navItem');

      this.element.find('.cmp-masthead__primary-nav-dropdown-content').show();

      this.$dropdownButtonContainer.on(
        'mouseenter',
        $.proxy(function (event) {
          this.showDropdownContent($(event.currentTarget));
        }, this)
      );

      this.$menuContainer.removeClass('cmp-masthead__menu--open');
      $('html, body').removeClass('no-scroll');
    } else {
      if (this.isMenuOpened) {
        this.$menuContainer.addClass('cmp-masthead__menu--open');

        disableBodyScroll(true, '.cmp-masthead__menu--open');

        $('html, body').addClass('no-scroll');
      } else {
        this.$menuContainer.removeClass('cmp-masthead__menu--open');
        $('html, body').removeClass('no-scroll');
        this.$menuContainer.hide();
      }

      this.$dropdownContent.hide();
      this.$dropdownButtonContainer.off('mouseenter');
      this.$dropdownButton.off('mouseleave');
      this.$dropdownContent.off('mouseleave');

      this.element
        .find('.cmp-masthead__primary-nav-dropdown-list')
        .css('max-height', 'unset');

      //Toggle Mobile Menu SubNav
      if (this.dropdownLinksEnabled) {
        this.$dropdownButtonIcon.off('click');
        this.$dropdownButtonIcon.on(
          'click',
          $.proxy(function (event) {
            event.preventDefault();
            this.toggleDropdownContent(
              $(event.target).closest(
                '.cmp-masthead__primary-nav-dropdown-button'
              )
            );
          }, this)
        );
      } else {
        this.$dropdownButton.off('click');
        this.$dropdownButton.on(
          'click',
          $.proxy(function (event) {
            event.preventDefault();
            this.toggleDropdownContent(
              $(event.target).closest(
                '.cmp-masthead__primary-nav-dropdown-button'
              )
            );
          }, this)
        );
      }
    }
  },

  showDropdownContent: function ($element) {
    var _this = this;

    $element.off('mouseenter');

    var $dropdownContent = $element.find(
      '.cmp-masthead__primary-nav-dropdown-content'
    );
    var $dropdownList = $element.find(
      '.cmp-masthead__primary-nav-dropdown-list--level2'
    );
    var $buttonElement = $element.find(
      '.cmp-masthead__primary-nav-dropdown-button'
    );

    $dropdownList.css('max-height', this.getDropdownListHeight($dropdownList));
    $dropdownContent.addClass('slideDown');

    $buttonElement.on(
      'mouseleave',
      $.proxy(function (event) {
        if (
          !$(event.relatedTarget).hasClass(
            'cmp-masthead__primary-nav-dropdown-content'
          ) &&
          !$(event.relatedTarget).hasClass(
            'cmp-masthead__primary-nav-dropdown-item'
          )
        ) {
          _this.hideDropdownContent(
            $(event.currentTarget).closest(
              '.cmp-masthead__primary-nav__item--dropdown'
            )
          );
        }
      }, _this)
    );

    $dropdownContent.on(
      'mouseleave',
      $.proxy(function (event) {
        if (
          !$(event.relatedTarget).hasClass(
            'cmp-masthead__primary-nav-item--open'
          )
        ) {
          _this.hideDropdownContent(
            $(event.currentTarget).closest(
              '.cmp-masthead__primary-nav__item--dropdown'
            )
          );
        }
      }, _this)
    );

    $buttonElement.addClass('cmp-masthead__primary-nav-item--open');
  },

  getDropdownListHeight: function ($dropdownList) {
    var _this = this;
    var dropdownListHeight = 0;
    $dropdownList
      .children('.cmp-masthead__primary-nav-dropdown-items')
      .each(function () {
        dropdownListHeight += $(this).outerHeight();
        $(this)
          .find('.cmp-masthead__primary-nav-dropdown-item--level3')
          .each(function () {
            dropdownListHeight += $(this).outerHeight();
          });
      });

    return dropdownListHeight;
  },

  hideDropdownContent: function ($element) {
    var _this = this;
    var $dropdownContent = $element.find(
      '.cmp-masthead__primary-nav-dropdown-content'
    );
    var $dropdownList = $element.find(
      '.cmp-masthead__primary-nav-dropdown-list'
    );
    var $buttonElement = $element.find(
      '.cmp-masthead__primary-nav-dropdown-button'
    );

    $dropdownContent.off('mouseleave');
    $buttonElement.off('mouseleave');

    $element.on(
      'mouseenter',
      $.proxy(function (event) {
        this.showDropdownContent($(event.currentTarget));
      }, this)
    );

    $dropdownList.css('max-height', 0);
    $dropdownContent.removeClass('slideDown');

    $buttonElement.removeClass('cmp-masthead__primary-nav-item--open');
  },

  toggleMenu: function () {
    if (this.isMenuOpened) {
      this.$menuButton.removeClass('cmp-masthead__menu-button--open');
      this.$menuContainer.slideToggle('fast');

      disableBodyScroll(false, '.cmp-masthead__menu--open');

      this.$menuContainer.removeClass('cmp-masthead__menu--open');
      $('html, body').removeClass('no-scroll');

      this.isMenuOpened = false;
    } else if (this.$menuButton.is(':visible')) {
      this.$menuButton.addClass('cmp-masthead__menu-button--open');
      this.$menuContainer.slideToggle('fast');
      this.$menuContainer.addClass('cmp-masthead__menu--open');

      disableBodyScroll(true, '.cmp-masthead__menu--open');

      $('html, body').addClass('no-scroll');

      this.isMenuOpened = true;

      if (this.isSearchOpened) {
        this.toggleSearch();
      }
    }
  },

  toggleSearch: function () {
    if (this.isSearchOpened) {
      this.$searchButton.removeClass('cmp-masthead__search-button--open');
      this.$searchContainer.slideToggle('fast');
      this.isSearchOpened = false;
    } else {
      this.$searchButton.addClass('cmp-masthead__search-button--open');
      this.$searchContainer.slideToggle('fast');
      this.isSearchOpened = true;

      if (this.isMenuOpened) {
        this.toggleMenu();
      }
    }
  },
});

(function ($) {
  //Initialize Masthead widget
  $('.cmp-masthead').masthead();
})(jQuery);

// Sticky Masthead

// Stycky options

// "all-sticky"
//    All breakpoints:
//      Scroll down: Entire Nav stays sticky
//      Scroll up: Entire Nav stays sticky

// "hide-all"
//    Mobile:
//      Scroll down: Entire Nav goes away
//      Scroll up: Entire Nav comes back

//    Tablet:
//      Scroll down: Entire Nav stays sticky
//      Scroll up: Entire Nav stays sticky

//    Desktop:
//      Scroll down: Entire Nav stays sticky
//      Scroll up: Entire Nav stays sticky

// "hide-links"
//    Mobile:
//      Scroll down: Only utility nav links goes away, the rest of the Nav stays sticky
//      Scroll up: utility nav links comes back

//    Tablet:
//      Scroll down: Entire Nav stays sticky
//      Scroll up: Entire Nav stays sticky

//    Desktop:
//      Scroll down: Entire Nav stays sticky
//      Scroll up: Entire Nav stays sticky

$.widget('gene.stickyNav', {
  _create: function () {
    //this.element and this.options are available here

    this.$heightPlacholder = $('<div>').addClass('sticky-height-placeholder'); // insert hidden element to maintain actual top offset on page
    this.stickyOptionMobile = this.element.data('sticky-option-mobile');
    this.stickyOptionDesktop = this.element.data('sticky-option-desktop');

    this.stickyEnabledMobile =
      GeneCore.properties.isMastheadStickyEnabledMobile;
    this.stickyEnabledDesktop =
      GeneCore.properties.isMastheadStickyEnabledDesktop;

    var currentBreakpoint = GeneCore.utils.resizeUtil.getCurrentBreakpoint();

    if (
      ((currentBreakpoint == 'xs' || currentBreakpoint == 'md') &&
        this.stickyEnabledMobile) ||
      (currentBreakpoint == 'lg' && this.stickyEnabledDesktop)
    ) {
      this.element.addClass('sticky');
    }

    this.element.before(this.$heightPlacholder);

    $(window).on(
      'breakpoint-change',
      $.proxy(this._breakpointChangeHandler, this)
    );
  },

  _breakpointChangeHandler: function (e, breakpoint) {
    // Habilitar el sticky en base al breakpoint
    if (breakpoint == 'xs' || breakpoint == 'md') {
      if (this.stickyEnabledMobile) {
        this.element.addClass('sticky');
      } else {
        this.element.removeClass('sticky');
        this.$heightPlacholder.height(0);
      }
    }

    if (breakpoint == 'lg') {
      if (this.stickyEnabledDesktop) {
        this.element.addClass('sticky');
      } else {
        this.element.removeClass('sticky');
        this.$heightPlacholder.height(0);
      }
    }

    if (
      (breakpoint == 'xs' || breakpoint == 'md') &&
      this.stickyOptionMobile == 'hide-all' &&
      this.stickyEnabledMobile
    ) {
      $(window).off('scroll.sticky-onscroll resize.sticky-onscroll');

      $(window).on(
        'scroll-direction-change',
        $.proxy(function (e, direction) {
          this._stickyToggleOnlyUp(direction);
        }, this)
      );

      this._stickyToggleOnlyUp('up');
    }

    if (
      ((breakpoint == 'xs' || breakpoint == 'md') &&
        (this.stickyOptionMobile == 'all-sticky' ||
          this.stickyOptionMobile == 'hide-links') &&
        this.stickyEnabledMobile) ||
      (breakpoint == 'lg' && this.stickyEnabledDesktop)
    ) {
      $(window).off('scroll-direction-change');

      if (
        (breakpoint == 'xs' || breakpoint == 'md') &&
        this.stickyOptionMobile == 'hide-links' &&
        this.stickyEnabledMobile
      ) {
        $(window).on(
          'scroll-direction-change',
          _.throttle(function (e, direction) {
            if (direction == 'up') {
              $('.cmp-masthead__utility-nav-upper').slideDown('fast');
            } else {
              $('.cmp-masthead__utility-nav-upper').slideUp('fast');
            }
          }, 210)
        );
      }

      $(window).on(
        'scroll.sticky-onscroll resize.sticky-onscroll',
        $.proxy(function () {
          this.stickyToggle();
        }, this)
      );

      this.stickyToggle();
    }

    if (breakpoint == 'md' && this.stickyEnabledMobile) {
      $('.cmp-masthead__utility-nav-upper').show();
    }

    if (breakpoint == 'lg') {
      $('.cmp-masthead__utility-nav-upper').css('display:', '');
    }

    GeneCore.promises.mastheadReadyPromise.resolve();
  },

  _stickyToggleOnlyUp: function (direction) {
    var stickyHeight = this.element.outerHeight();
    var stickyTop = this.$heightPlacholder.offset().top;

    GeneCore.properties.stickyMastheadHeight = stickyHeight;

    if ($(window).scrollTop() >= stickyHeight) {
      this.$heightPlacholder.height(stickyHeight);
      this.element.addClass('is-sticky sticky-full-width');

      if (direction === 'up') {
        this.element.addClass('shown');
      } else {
        this.element.removeClass('shown');
      }
    } else {
      if ($(window).scrollTop() <= stickyTop + 3) {
        this.element.removeClass('is-sticky sticky-full-width');
        this.$heightPlacholder.height('auto');
      }
    }
  },

  stickyToggle: function () {
    var stickyHeight = this.element.outerHeight();
    var stickyTop = this.$heightPlacholder.offset().top;

    GeneCore.properties.stickyMastheadHeight = stickyHeight;

    if ($(window).scrollTop() >= stickyTop) {
      this.element.addClass('shown');
      this.element.addClass('is-sticky sticky-full-width');
      this.$heightPlacholder.height(stickyHeight);
    } else {
      this.element.removeClass('shown');
      this.element.removeClass('is-sticky sticky-full-width');
      this.$heightPlacholder.height('auto');
    }
  },
});

(function ($) {
  GeneCore.properties.stickyMastheadHeight = 0;
  GeneCore.properties.isMastheadStickyEnabledDesktop =
    $('.cmp-masthead').data('sticky-option-desktop') != 'not-sticky';
  GeneCore.properties.isMastheadStickyEnabledMobile =
    $('.cmp-masthead').data('sticky-option-mobile') != 'not-sticky';

  //Initialize Sticky Nav widget
  var $masthead = $('.cmp-masthead');
  if (
    $masthead.length &&
    (GeneCore.properties.isMastheadStickyEnabledDesktop ||
      GeneCore.properties.isMastheadStickyEnabledMobile)
  ) {
    $('.cmp-masthead').stickyNav();
  } else {
    GeneCore.promises.mastheadReadyPromise.resolve();
  }
})(jQuery);

$.widget('gene.references', {
  _create: function () {
    this.regex = /(\d{1,2}[-]\d{1,2}|\d+)/g;
    this.singularHeading = this.element.data('singularHeading');
    this.pluralHeading = this.element.data('pluralHeading');

    this._initReferences();

    // Check if there is no references on the loaded page
    this.referencesCount = this.element.find(
      '.cmp-references__item.cmp-references__item--visible'
    ).length;
    if (this.referencesCount == 0) {
      this.element.remove();
    } else {
      this._setHeader();

      if (this.referencesCount == 1) {
        this.element
          .find('.cmp-references__list')
          .addClass('cmp-references__list--full-width');
        this.element.find('.cmp-references__list-column--2').remove();
      } else {
        this._splitItems();
      }
    }
  },

  _splitItems: function () {
    var activeItems = this.element.find('.cmp-references__item--visible');

    var $col2 = this.element.find('.cmp-references__list-column--2 ul');

    var activePerColumn = Math.ceil(activeItems.length / 2);
    $.each(activeItems, function (index, item) {
      if (index > activePerColumn - 1) {
        $col2.append(item);
      }
    });
  },

  _setHeader: function () {
    this.element
      .find('.cmp-references__title')
      .text(
        this.referencesCount > 1 ? this.pluralHeading : this.singularHeading
      );
  },

  _initReferences: function () {
    var _this = this;
    $('.reference').each(function () {
      _this._initReference($(this));
    });
  },

  _initReference: function ($reference) {
    var _this = this;
    var refText = $reference.text() ? $reference.text().match(this.regex) : '';
    var refNumber = $reference.is('img')
      ? $reference.data('reference-number')
      : refText;
    var refElements = {};
    var refNumbers = this._parseRefs(refNumber ? refNumber.toString() : '');

    $.each(refNumbers, function (index, value) {
      var $refEl = _this.element.find(
        "[data-reference-number='" + value + "']"
      );
      var id = $refEl.attr('id');
      refElements[id] = {
        el: $refEl,
        key: value,
      };
    });

    if (!jQuery.isEmptyObject(refElements)) {
      var contentList = [];
      $.each(refElements, function (key, value) {
        var $referenceItem = value.el;
        if ($referenceItem) {
          if (!$referenceItem.hasClass('cmp-references__item--visible')) {
            $referenceItem.addClass('cmp-references__item--visible');
          }
          if (
            typeof $referenceItem
              .find('.cmp-references__item-content')
              .html() !== 'undefined'
          ) {
            contentList.push(
              '<dt>' +
                value.key +
                '.</dt><dd>' +
                $referenceItem.find('.cmp-references__item-content').html() +
                '</dd>'
            );
          }
        }
      });

      if (!$reference.hasClass('reference--no-tooltip')) {
        $reference.geneTooltip({
          content: '<dl>' + contentList.join('') + '</dl>',
        });
        $reference.attr('aria-describedby', Object.keys(refElements).join(' '));
      }
    }
  },
  _parseRefs: function (txtStr) {
    var finalList = [],
      commaList = [],
      hyphenList = [];
    if ('string' === typeof txtStr && '' != txtStr) {
      commaList = txtStr.split(',');
      for (var i = 0; i < commaList.length; i++) {
        if (commaList[i].indexOf('-') > -1) {
          hyphenList = commaList[i].split('-');
          if (parseInt(hyphenList[0], 10) < parseInt(hyphenList[1], 10)) {
            first = parseInt(hyphenList[0], 10);
            last = parseInt(hyphenList[1], 10);
          } else {
            first = parseInt(hyphenList[1], 10);
            last = parseInt(hyphenList[0], 10);
          }

          for (var j = first; j <= last; j++) {
            finalList.push(j);
          }
        } else {
          finalList.push(parseInt(commaList[i], 10));
        }
      }
      finalList.sort(function (a, b) {
        return a - b;
      });
    }
    return finalList;
  },
});

(function ($) {
  //Initialize References widgets
  $('.cmp-references').references();
})(jQuery);

$.widget('gene.backToTop', {
  _create: function () {
    //this.element and this.options are available here

    this.scrollThreshold = 100; // determine when to display back to top element
    this.delayScroll = 200;
    this.isHidden = true;

    $(window).on(
      'scroll.backtotop',
      _.throttle($.proxy(this._toggleClass, this), this.delayScroll)
    );

    this.element.on('click.backtotop', function () {
      GeneCore.utils.anchorsUtil.scrollToYPosition(0, false);
    });

    $(window).on('safetybar:resize', $.proxy(this._positionHandler, this));
  },

  _positionHandler: function (event, saftyBarArgs) {
    if (saftyBarArgs.isSticky) {
      var windowScrollTop = $(window).scrollTop();
      this.isHidden = false;

      if (windowScrollTop > this.scrollThreshold) {
        this.element.addClass('is-visible');
        this.element.css('bottom', saftyBarArgs.height + 15 + 'px');
      }
    } else {
      this.isHidden = true;
      this.element.removeClass('is-visible');
    }
  },

  _toggleClass: function () {
    var windowScrollTop = $(window).scrollTop();
    if (!this.isHidden) {
      this.element.toggleClass(
        'is-visible',
        windowScrollTop > this.scrollThreshold
      );
    }
  },
});

(function ($) {
  //Initialize Back to Top widgets
  $('.cmp-backtotop').backToTop();
})(jQuery);

$.widget('gene.searchResults', {
  _create: function () {
    var _self = this; //cache current object

    $('.btnMoreResults').click(function () {
      _self._getMoreResults(_self);
    });

    this.currentOffset = this.element
      .find('.cmp-searchresults__results-container')
      .data('currentOffset');
    this.resultsTotal = this.element.data('resultsTotal');
    this.resultsPerPage = this.element.data('resultsPerPage');
    this.fullTextQuery = this.element.data('fullTextQuery');

    this.element
      .find('.cmp-searchresults__pagination-prev')
      .on('click', $.proxy(this._goToPreviousPage, this));
    this.element
      .find('.cmp-searchresults__pagination-next')
      .on('click', $.proxy(this._goToNextPage, this));
    this.element
      .find('.cmp-searchresults__pagination-item')
      .on('click', $.proxy(this._onClickPageHandler, this));

    this.paginationContainer = this.element.find(
      '.cmp-searchresults__pagination'
    );

    this._populateSearchInput();
  },

  _goToPreviousPage: function (event) {
    var $element = $(event.currentTarget);

    if (!$element.hasClass('disabled')) {
      var prevOffset = this.currentOffset - this.resultsPerPage;
      this._goToPage(prevOffset);
    }
  },

  _goToNextPage: function (event) {
    var $element = $(event.currentTarget);

    if (!$element.hasClass('disabled')) {
      var nextOffset = this.currentOffset + this.resultsPerPage;
      this._goToPage(nextOffset);
    }
  },

  _onClickPageHandler: function (event) {
    var $element = $(event.currentTarget);

    if (!$element.hasClass('disabled')) {
      this._goToPage($element.data('offset'));
    }
  },

  _goToPage: function (offset) {
    var query = this._getURLParameter('q');
    var resultCount = this._getURLParameter('r');
    var _this = this;

    $.ajax({
      url:
        window.location.pathname.substr(
          0,
          window.location.pathname.lastIndexOf('.')
        ) +
        '.site.search.html?isAjax=true&offset=' +
        offset +
        '&q=' +
        query +
        '&r=' +
        resultCount,
      type: 'GET',
      dataType: 'json',
      success: function (data) {
        _this.element
          .find('.cmp-searchresults__results-container')
          .replaceWith(data.resultsHtml);
        _this.currentOffset = _this.element
          .find('.cmp-searchresults__results-container')
          .data('currentOffset');
        _this._updatePagination(_this.currentOffset);
        GeneCore.utils.anchorsUtil.scrollToYPosition(0);
      },
    });
  },

  _updatePagination: function (currentOffset) {
    this.paginationContainer
      .find('.cmp-searchresults__pagination-item')
      .each(function (index, element) {
        var $this = $(element);
        $this.removeClass('disabled');

        if ($this.data('offset') == currentOffset) {
          $this.addClass('disabled');
        }
      });

    var $prevButton = this.paginationContainer.find(
      '.cmp-searchresults__pagination-prev'
    );
    var $nextButton = this.paginationContainer.find(
      '.cmp-searchresults__pagination-next'
    );

    if (currentOffset == 0) {
      // disable prev button
      $prevButton.addClass('disabled');
    } else {
      // enable
      $prevButton.removeClass('disabled');
    }

    if (currentOffset + this.resultsPerPage > this.resultsTotal) {
      // disable next button
      $nextButton.addClass('disabled');
    } else {
      $nextButton.removeClass('disabled');
    }
  },

  _populateSearchInput: function () {
    var query = this._getURLParameter('q');

    if (query !== null) {
      //decode search query returned from server using decodeURIComponent method and use regex to remove any instances of +
      this.element
        .find('.cmp-searchinput__input')
        .val(decodeURIComponent(query.replace(new RegExp('\\+', 'g'), ' ')));
    }
  },

  _getURLParameter: function (sParam) {
    var sPageURL = window.location.search.substring(1);
    var sURLVariables = sPageURL.split('&');
    for (var i = 0; i < sURLVariables.length; i++) {
      var sParameterName = sURLVariables[i].split('=');
      if (sParameterName[0] == sParam) {
        return sParameterName[1];
      }
    }

    return null;
  },
});

(function ($) {
  //Initialize Back to Top widgets
  $('.cmp-searchresults').searchResults();
})(jQuery);

/*
 Adobe AEM Brightcove Connector

 Copyright (C) 2018 Coresecure Inc.

 Authors:
 Alessandro Bonfatti
 Yan Kisen
 Pablo Kropilnicki

 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with this program.  If not, see <http://www.gnu.org/licenses/>.

 - Additional permission under GNU GPL version 3 section 7
 If you modify this Program, or any covered work, by linking or combining
 it with httpclient 4.1.3, httpcore 4.1.4, httpmine 4.1.3, jsoup 1.7.2,
 squeakysand-commons and squeakysand-osgi (or a modified version of those
 libraries), containing parts covered by the terms of APACHE LICENSE 2.0
 or MIT License, the licensors of this Program grant you additional
 permission to convey the resulting work.
 */

//setVideoTrackingEvents();

function r(f) {
  /in/.test(document.readyState) ? setTimeout('r(' + f + ')', 9) : f();
}
// use like
r(function () {
  createPlayers();
});
function createPlayers() {
  var all = document.getElementsByClassName('brightcove-container');
  for (var i = 0, max = all.length; i < max; i++) {
    var selected_element = all[i];
    var playerID = selected_element.getAttribute('data-playerid');
    try {
      videojs(playerID).dispose();
    } catch (e) {}
    var dataAccount = selected_element.getAttribute('data-account');
    var dataPlayer = selected_element.getAttribute('data-player');
    var dataEmbed = selected_element.getAttribute('data-embed');
    var dataVideoId = selected_element.getAttribute('data-video-id');
    var dataWidth = selected_element.getAttribute('data-width');
    var dataHeight = selected_element.getAttribute('data-height');
    var dataUsage = selected_element.getAttribute('data-usage');
    var s = document.createElement('script');
    s.src =
      '//players.brightcove.net/' +
      dataAccount +
      '/' +
      dataPlayer +
      '_' +
      dataEmbed +
      '/index.min.js';
    s.onload = (function (
      playerID,
      dataVideoId,
      dataAccount,
      dataPlayer,
      dataEmbed,
      dataWidth,
      dataHeight,
      selected_element
    ) {
      return function () {
        playerHTML =
          '<video id="' +
          playerID +
          '" data-video-id="' +
          dataVideoId +
          '"  data-account="' +
          dataAccount +
          '" data-player="' +
          dataPlayer +
          '" data-embed="' +
          dataEmbed +
          '" data-usage="' +
          dataUsage +
          '" class="video-js" controls width="' +
          dataWidth +
          '" height="' +
          dataHeight +
          '"></video>';
        selected_element.innerHTML = playerHTML;
        bc(document.getElementById(playerID));
        videojs(playerID).ready(function () {
          myPlayer = this;
          if (typeof myPlayer !== 'undefined' && typeof ga != 'undefined') {
            myPlayer.on('firstplay', function () {
              var videoName = myPlayer.mediainfo.name;
              var videoID = myPlayer.mediainfo.id;
              var videoDuration = myPlayer.mediainfo.duration;
              ga(
                'send',
                'video',
                'firstplay',
                videoName + ' - ' + videoID + ' - ' + videoDuration
              );
            });
            myPlayer.on('play', function () {
              var videoName = myPlayer.mediainfo.name;
              var videoID = myPlayer.mediainfo.id;
              ga(
                'send',
                'video',
                'play',
                videoName + ' - ' + videoID,
                myPlayer.currentTime()
              );
            });
            myPlayer.on('ended', function () {
              var videoName = myPlayer.mediainfo.name;
              var videoID = myPlayer.mediainfo.id;
              ga(
                'send',
                'video',
                'ended',
                videoName + ' - ' + videoID,
                myPlayer.currentTime()
              );
            });
            myPlayer.on('fullscreenchange', function () {
              var videoName = myPlayer.mediainfo.name;
              var videoID = myPlayer.mediainfo.id;
              ga(
                'send',
                'video',
                'fullscreenchange',
                videoName + ' - ' + videoID,
                myPlayer.currentTime() +
                  (myPlayer.isFullscreen() ? ' Fullscreen' : '')
              );
            });
            myPlayer.on('pause', function () {
              var videoName = myPlayer.mediainfo.name;
              var videoID = myPlayer.mediainfo.id;
              ga(
                'send',
                'video',
                'pause',
                videoName + ' - ' + videoID,
                myPlayer.currentTime()
              );
            });
            myPlayer.on('resize', function () {
              var videoName = myPlayer.mediainfo.name;
              var videoID = myPlayer.mediainfo.id;
              ga(
                'send',
                'video',
                'resize',
                videoName + ' - ' + videoID,
                myPlayer.currentTime()
              );
            });
            myPlayer.on('seeked', function () {
              var videoName = myPlayer.mediainfo.name;
              var videoID = myPlayer.mediainfo.id;
              ga(
                'send',
                'video',
                'seeked',
                videoName + ' - ' + videoID,
                myPlayer.currentTime()
              );
            });
            myPlayer.on('volumechange', function () {
              var videoName = myPlayer.mediainfo.name;
              var videoID = myPlayer.mediainfo.id;
              ga(
                'send',
                'video',
                'volumechange',
                videoName + ' - ' + videoID,
                myPlayer.volume() * 100 +
                  '%' +
                  (myPlayer.muted() ? ' Muted' : '')
              );
            });
          }
        });
      };
    })(
      playerID,
      dataVideoId,
      dataAccount,
      dataPlayer,
      dataEmbed,
      dataWidth,
      dataHeight,
      selected_element
    );
    document.body.appendChild(s);
  }
}
(function ($) {
  var dropdown = $('.cmp-resources-dropdown'),
    select = $('.cmp-resources-dropdown__select'),
    menu = $('.cmp-resources-dropdown__menu'),
    menuItems,
    selected,
    activeMenu,
    setHeight;

  select.on('click', function (e) {
    e.preventDefault();

    menuItems = $('.cmp-resources-dropdown__menu li');
    selected = $(this).find('.selected');
    activeMenu = $(this).siblings('.cmp-resources-dropdown__menu');
    menuItems = $('.cmp-resources-dropdown__menu li');

    if (activeMenu.hasClass('active')) {
      select.removeClass('active');
      menu.removeClass('active');
    } else {
      select.removeClass('active');
      menu.removeClass('active');
      $(this).addClass('active');
      activeMenu.addClass('active');
    }

    setHeight = window.innerHeight - this.getBoundingClientRect().bottom - 100;
    if (setHeight < 100) {
      setHeight = 100;
    }
    if (activeMenu.hasClass('active') && activeMenu.height() > setHeight) {
      activeMenu.outerHeight(setHeight);
    } else {
      activeMenu.outerHeight('auto');
    }

    menuItems.on('click', function () {
      selected.text($(this).text());

      $(this).siblings('li').removeClass('active');
      $(this).addClass('active');

      select.removeClass('active');
      menu.removeClass('active');
    });
  });

  $(document).click(function (e) {
    if (e.target != $(dropdown) && !$(dropdown).find(e.target).length) {
      select.removeClass('active');
      menu.removeClass('active');
      menu.outerHeight('auto');
    }
  });
})(jQuery);

$.widget('gene.resources', {
  _create: function () {
    this.$resources = this.element.find('li.cmp-resources__item');
    this.downloadButton = this.element.find('.cmp-resources__download-button');
    this.filter = this.element.find('.cmp-resources__filter');
    this.selectDL = this.element.find('.cmp-resources__download-select');
    this.selectAll = this.element.find('.cmp-resources__download-select-all');
    this.tags = [];

    //populate tags
    this._populateTagsArray();
    //create tags filter
    if (this.filter) {
      this._populateFilter();
    }
    this._handleSelectedItem();
    this._handleSelectAll();
    this._handleNoLinkOnDownload();
    this._handleSeeMoreLink();
  },

  _handleSeeMoreLink: function () {
    if (
      this.element.find('.cmp-resources__list--tiles').length &&
      this.element.find('.cmp-resources__desc')
    ) {
      this._removeLink();
      $(window).resize(function () {
        this._removeLink();
      });
    }
  },

  _removeLink: function () {
    this.$resources.each(function () {
      var seeMore = $(this).find('.cmp-resources__see-more');
      var $element = $(this).find('.cmp-resources__desc');
      var $c = $element
        .clone()
        .css({
          display: 'block',
          width: $element.width(),
          height: 'auto',
          visibility: 'hidden',
        })
        .appendTo('body');
      if ($c.height() <= $element.height()) {
        seeMore.css('display', 'none');
      } else {
        seeMore.css('display', 'block');
      }
      $c.remove();
    });
  },

  _handleNoLinkOnDownload: function () {
    this.downloadButton.on('click', function (e) {
      if ($(this).attr('href') === '#') {
        e.preventDefault();
      }
    });
  },

  _handleSelectAll: function () {
    var _this = this;
    if (this.selectAll) {
      this.selectAll.change(function (event) {
        _this.selectDL.prop('checked', $(this).prop('checked'));
        _this._countSelected();
        _this._downloadPath();
      });
    }
  },

  _handleSelectedItem: function () {
    var _this = this;
    this.selectDL.change(function (event) {
      if (_this.selectAll.prop('checked')) {
        _this.selectAll.prop('checked', false);
      }
      _this._countSelected();
      _this._downloadPath();
    });
  },

  _populateFilter: function () {
    var _this = this;
    $.each(this.tags, function (index, value) {
      var appendedElement = $('<li></li>')
        .text(value)
        .addClass('cmp-resource__tag');
      _this.filter
        .siblings('ul.cmp-resources__options')
        .append(appendedElement);
    });

    //attach listeners
    var filterOptions = this.element.find('.cmp-resources__options').children();
    var selected;
    filterOptions.on('click', function () {
      selected = $(this).text();
      _this.filter.trigger('filterChange');
    });

    this.filter.bind('filterChange', function (event) {
      if (selected === 'Show All') {
        _this.$resources.show();
      } else {
        _this.$resources.each(function (index) {
          if (
            $(this).not('[data-resource-tags]').length ||
            $(this).data('resourceTags').search(selected) === -1
          ) {
            $(this).hide();
            $(this).find('input[type="checkbox"]').prop('checked', false);
          } else {
            $(this).show();
          }
        });
      }
      //select all reset
      _this.element.find('#select-all').prop('checked', false);
      _this.$resources.each(function (index) {
        $(this).find('input[type="checkbox"]').prop('checked', false);
      });
      //recount
      _this._countSelected();
      _this._downloadPath();
    });
  },

  _downloadPath: function () {
    var downloadStr = '/.resourcesdownload.zip/download.zip?';
    var n = 0;
    this.selectDL.each(function (index, value) {
      if ($(this).is(':checked:visible')) {
        if (n !== 0) {
          downloadStr += '&';
        }
        downloadStr += 'path=' + $(this).attr('data-resource-path');
        n++;
      }
    });

    //update the selected and download button
    if (this._countSelected(false) > 0) {
      this.downloadButton.attr('href', downloadStr).removeAttr('disabled');
    } else {
      this.downloadButton.attr('href', '#').attr('disabled', 'disabled');
    }
  },

  _countSelected: function (setText) {
    if (setText !== false) {
      setText = true;
    }
    var selectCount = 0;
    this.selectDL.each(function (index) {
      if ($(this).is(':checked:visible')) {
        selectCount++;
      }
    });

    if (setText) {
      var selectString =
        selectCount === 1
          ? selectCount + ' file selected'
          : selectCount + ' files selected';
      this.element.find('.cmp-resources__selected-count').text(selectString);
    }
    return selectCount;
  },

  _populateTagsArray: function () {
    var _this = this;
    this.$resources.each(function (index) {
      if ($(this).data('resourceTags')) {
        var resourceTags = $(this).data('resourceTags').split(',');
        $.each(resourceTags, function (index, value) {
          if ($.inArray(value.trim(), _this.tags) === -1) {
            console.log('this is ' + _this);
            _this.tags.push(value.trim());
          }
        });
      }
    });
  },
});

(function ($) {
  //Initialize resources component
  $('.cmp-resources').resources();
})(jQuery);

(function ($) {
  //Accessibility code for focus on stylized 0 opacity inputs via keyboard.
  var mousedownSelectors =
    '.cmp-form-options--checkbox input,' +
    '.cmp-form-options--radio input,' +
    '.cmp-form-options--checkbox label,' +
    '.cmp-form-options--radio label';

  var focusSelectors =
    '.cmp-form-options--checkbox input,' + '.cmp-form-options--radio input';

  var mousedown = false;
  $(mousedownSelectors).on('mousedown', function () {
    mousedown = true;
  });

  $(focusSelectors).on('focusin', function () {
    if (!mousedown) {
      $(this).parent().addClass('input-keyboard-focus');
    }
    mousedown = false;
  });

  $(focusSelectors).on('focusout', function () {
    $(this).parent().removeClass('input-keyboard-focus');
  });

  //Initialize Validate Immediately feature if applicable
  $('.cmp-form-options').each(function () {
    var $component = $(this),
      validateImmediately = $component.data('validate-immeditely');

    if (validateImmediately) {
      $component.find('input:first-of-type, select').each(function () {
        $(this).change(function () {
          if (!$(this).parsley().isValid()) {
            $(this).parsley().validate();
          }
        });
      });
    }
  });
})(jQuery);

window.Parsley.addValidator('invalidOptions', {
  validateMultiple: function (_value, invalidValues, parsleyInstance) {
    var passesCheck = true;

    var invalidOptions = invalidValues.split('||');

    for (key in _value) {
      if (invalidOptions.includes(_value[key])) {
        passesCheck = false;
      }
    }

    if (passesCheck) {
      return true;
    } else {
      return $.Deferred().reject(
        parsleyInstance.$element.data('parsley-invalid-value-message')
      );
    }
  },
  validateString: function (_value, invalidValues, parsleyInstance) {
    var invalidOptions = invalidValues.split('||');

    if (!invalidOptions.includes(_value)) {
      return true;
    } else {
      return $.Deferred().reject(
        parsleyInstance.$element.data('parsley-invalid-value-message')
      );
    }
  },
  requirementType: 'string',
  messages: {
    en: 'One or more selected values are not valid for this form.',
  },
});

$.widget('gene.glossaryTooltip', {
  _create: function () {
    this.glossaryTerms = this._getGlossaryTerms();
    this._initGlossaryTooltips();
  },

  _getGlossaryTerms: function () {
    var results = {};
    var glossaryTerms = this.element.data('glossaryJson');

    $.each(glossaryTerms, function (i, item) {
      results[item.term.trim().toLowerCase()] = {
        definition: item.definition,
        added: false,
        originalTerm: item.term,
      };

      var termVariants;

      if (item.variants) {
        termVariants = item.variants.split(',');
        $.each(termVariants, function (i, variant) {
          var newTerm = variant.trim().toLowerCase();
          // Check if term exists in array
          if (!$.inArray(newTerm, results)) {
            results[newTerm] = {
              definition: item.definition,
              added: false,
              originalTerm: item.term,
            };
          }
        });
      }
    });
    return results;
  },

  _encodeTermForRegex: function (term) {
    term = term
      .replace('\\', '\\\\')
      .replace('+', '\\+')
      .replace('?', '\\?')
      .replace('$', '\\$')
      .replace('^', '\\^')
      .replace('*', '\\*')
      .replace('[', '\\[')
      .replace(']', '\\]')
      .replace('(', '\\(')
      .replace(')', '\\)');
    return '\\b' + term + '\\b';
  },

  _searchTerms: function (
    node,
    callback,
    excludeElements,
    excludeElementsByClass
  ) {
    var child = node.firstChild;

    while (child) {
      switch (child.nodeType) {
        case 1:
          if (
            excludeElements.indexOf(child.tagName.toLowerCase()) > -1 ||
            (typeof child.className === 'string' &&
              this._isExcluded(child.className, excludeElementsByClass))
          ) {
            break;
          }
          this._searchTerms(
            child,
            callback,
            excludeElements,
            excludeElementsByClass
          );
          break;
        case 3:
          var _this = this;
          $.each(this.glossaryTerms, function (term, data) {
            if (child.data.trim() !== '' && !data.added) {
              var bk = 0;
              var encodedTerm = _this._encodeTermForRegex(term);
              var regex = new RegExp(encodedTerm, 'i');

              child.data.replace(regex, function (all) {
                var args = [].slice.call(arguments),
                  offset = args[args.length - 2],
                  newTextNode = child.splitText(offset + bk),
                  tag;
                bk -= child.data.length + all.length;

                newTextNode.data = newTextNode.data.substr(all.length);
                tag = callback.apply(window, [child].concat(args));
                child.parentNode.insertBefore(tag, newTextNode);
                //child = newTextNode;

                $(tag).geneTooltip({
                  title: term,
                  content: data.definition,
                  originalTerm: data.originalTerm,
                });
                $(tag).attr(
                  'aria-label',
                  'Glossary: ' +
                    GeneCore.utils.generalUtils.removeTags(data.definition)
                );
                data.added = true;
              });
            }
          });

          break;
      }

      child = child.nextSibling;
    }

    return node;
  },

  _isExcluded: function (classes, excludedClasses) {
    var exclude = false;
    $.each(excludedClasses, function (index, element) {
      if (classes.includes(element)) {
        exclude = true;
      }
    });

    return exclude;
  },

  _initGlossaryTooltips: function () {
    var context = document.body;
    this._searchTerms(
      context,
      function (node, match, offset) {
        var abbr = document.createElement('abbr');
        abbr.className = 'cmp-glossary-tooltip';
        abbr.textContent = match;
        return abbr;
      },
      [
        'script',
        'style',
        'iframe',
        'canvas',
        'a',
        'h1',
        'h2',
        'h3',
        'h4',
        'h5',
        'h6',
      ],
      [
        'cmp-breadcrumb',
        'cmp-masthead',
        'cmp-glossary',
        'cmp-safetybar',
        'cmp-footer',
        'cmp-modal',
        'exclude-from-glossary',
        'cmp-tooltiptext',
      ]
    );
  },
});

(function ($) {
  //Initialize Tooltip widgets
  $('#glossary-list').glossaryTooltip();
})(jQuery);

$.fn.tooltipText = function () {
  var $this = $(this);
  var tooltipId = $this.attr('id');
  var tooltipContent = $this.html();

  $('[href="#' + tooltipId + '"]').geneTooltip({
    content: tooltipContent,
  });
};

$(document).ready(function () {
  $('.cmp-tooltiptext__item').each(function () {
    $(this).tooltipText();
  });
});

$.widget('gene.imageContentCard', {
  _create: function () {
    var $imageContainer = this.element.find('.cmp-iccard__image');

    var imgSrc = $imageContainer.find('img').attr('src');

    $imageContainer.css('background-image', 'url(' + imgSrc + ')');
  },
});

(function ($) {
  $('.cmp-iccard').imageContentCard();
})(jQuery);

$.widget('gene.searchInput', {
  _create: function () {
    var _self = this; //cache current object

    //check for require 2 terms
    if (
      this.element.find('.cmp-searchinput__container').data('require-two-terms')
    ) {
      this.element.find('.cmp-searchinput__form').submit(function (e) {
        if (!_self._hasTwoOrMoreTerms(e)) {
          _self._showNotEnoughTermsMessage();
          _self._clearSearchResults();
          e.preventDefault();
        }
      });
    }
  },

  _hasTwoOrMoreTerms: function (event) {
    var $form = $(event.currentTarget);
    var searchTerm = $form.find('.cmp-searchinput__input').val();
    return searchTerm.trim().indexOf(' ') !== -1;
  },

  _showNotEnoughTermsMessage: function () {
    $('.cmp-searchinput__not-enough-terms-text').removeClass(
      'hidden-publish-view'
    );
  },

  _clearSearchResults: function () {
    $(
      '.queryText, .noResultsText, .cmp-searchresults__results-container, .cmp-searchresults__pagination'
    ).html(' ');
  },
});

(function ($) {
  //Initialize Back to Top widgets
  $('.cmp-searchinput__wrapper').searchInput();
})(jQuery);

// handle responsive iframes
$.widget('gene.responsiveIframe', {
  _create: function () {
    this.ratio = this.element.data('iframe-ratio') || '16:9';
    this._initiFrames();
  },

  _initiFrames: function () {
    this.element.wrap(
      "<div class='responsive-iframe-wrap " +
        this._getTheRatioStyle() +
        "'></div>"
    );
  },

  _getTheRatioStyle: function () {
    let ratioClass = '';
    switch (this.ratio) {
      case '4:3':
        ratioClass = 'ratio-4_3';
        break;
      case '3:2':
        ratioClass = 'ratio-3_2';
        break;
      case '8:5':
        ratioClass = 'ratio-8_5';
        break;
      default:
        ratioClass = 'ratio-16_9';
    }
    return ratioClass;
  },
});

(function ($) {
  $('.cmp-htmlembed .responsive-iframe').responsiveIframe();
})(jQuery);

$.widget('gene.contentCard', {
  _create: function () {
    var $imageContainer = this.element.find('.cmp-ccard__image');
    var imageHeight = this.element
      .find('[data-image-height]')
      .data('imageHeight');

    var imgSrc = $imageContainer.find('img').attr('src');

    $imageContainer.css('background-image', 'url(' + imgSrc + ')');
    $imageContainer.css('height', imageHeight);
  },
});

(function ($) {
  $('.cmp-ccard').contentCard();
})(jQuery);

var DataLookupFormInjector = {
  Events: {
    PAGE_LOAD: 'datalookup.page.load',
    COMPONENT_INIT: 'datalookup.component.init',
    SUBMIT_INIT: 'datalookup.submit.init',
    RESET_INIT: 'datalookup.reset.init',
  },
};

jQuery(
  (function ($, cfg) {
    'use strict';
    $('body').trigger(cfg.Events.PAGE_LOAD);
  })(jQuery, DataLookupFormInjector)
);

$.widget('gene.datalookupform', {
  _create: function () {
    this.$form = this.element.closest('form');
    this.$resetButton = this.$form.find("[data-reset='true']");
  },
  _init: function () {
    $.observer.publish(DataLookupFormInjector.Events.COMPONENT_INIT);
    this.$form.submit($.proxy(this._search, this));
    // hide the error when the URL isn't configured
    this.$form
      .siblings('.cmp-form-container--error-container')
      .addClass('cmp-form-container--error-container--hidden');
    this.$resetButton.bind('click', $.proxy(this._reset, this));
  },
  _search: function (evt) {
    evt.preventDefault();
    $.observer.publish(DataLookupFormInjector.Events.SUBMIT_INIT, {
      elmId: this.$form.attr('id'),
      data: this.$form.serializeObject(),
    });
  },
  _reset: function (evt) {
    evt.preventDefault();
    $.observer.publish(DataLookupFormInjector.Events.RESET_INIT, {
      elmId: this.$form.attr('id'),
      data: this.$form.serializeObject(),
    });
  },
});

(function ($) {
  $('.cmp-datalookup-forminjector').datalookupform();
})(jQuery);

var DataLookupResults = {
  Events: {
    PAGE_LOAD: 'datalookup.results.load',
    COMPONENT_INIT: 'datalookup.results.init',
    RESULTS_INIT: 'datalookup.results.init',
    RESULTS_NOTFOUND: 'datalookup.results.notfound',
    RESULTS_HIDDEN: 'datalookup.results.hidden',
    RESULTS_SHOWN: 'datalookup.results.shown',
    FORM_HIDEN: 'datalookup.results.form.hidden',
    FORM_SHOWN: 'datalookup.results.form.shown',
    SEARCH_ERROR: 'datalookup.results.search.error',
    SEARCH_SUCCESS: 'datalookup.results.search.success',
    SEARCH_INITIALIZED: 'datalookup.results.search.initialized',
    RESET_INITIALIZED: 'datalookup.results.reset.initialized',
    RESULTCOMPONENT_INIT: 'datalookup.results.iniialized',
  },
};

jQuery(
  (function ($, cfg) {
    'use strict';
    $('body').trigger(cfg.Events.PAGE_LOAD);
  })(jQuery, DataLookupResults)
);

$.widget('gene.datalookupresults', {
  _create: function () {
    this.formId = this.element.data('form-id');
    this.hideForm = this.element.data('hide-form');
    this.backToForm = this.element.find('.cmp-datalookupresults_button-reset');
    this.cmpId = this.element.attr('id');
    this.templates = this.element.find(
      'script[type="text/x-handlebars-template"]'
    );
    this.displays = this.element.find('[data-header]');
    this.animate = this.element.data('animate');
    this.scroll = this.element.data('scroll');
    this.partialRules = [];
  },
  _init: function () {
    $.observer.publish(DataLookupResults.Events.RESULTCOMPONENT_INIT);
    this.registerObservers();
    this.registerHandlebar();
    if (this.hideForm) {
      this.backToForm.on(
        'click',
        $.proxy(function (evt) {
          evt.preventDefault();
          this._hideTheResutls();
        }, this)
      );
    }
  },
  registerObservers: function () {
    $.observer.subscribe(
      DataLookupFormInjector.Events.SUBMIT_INIT,
      $.proxy(this._search, this)
    );
    $.observer.subscribe(
      DataLookupFormInjector.Events.RESET_INIT,
      $.proxy(this._reset, this)
    );
  },
  registerHandlebar: function () {
    var $widget = this;
    this.tmpScript = Handlebars.compile(
      this.element.find('#' + this.cmpId + '_hbtemplate').html()
    );
    this.templates.each(function () {
      var html = $(this).html();
      var partialName = $(this).data('hb-template');
      var match = $(this).data('match');
      var header = $(this).data('header');
      Handlebars.registerPartial(partialName, Handlebars.compile(html));
      if (match && header && partialName) {
        $widget.partialRules.push({
          header: header,
          match: match,
          partialName: partialName,
        });
      }
    });

    Handlebars.registerHelper(
      this.cmpId + '_whichTemplate',
      function (record, context) {
        return $widget._getPartial(record);
      }
    );
    Handlebars.registerHelper('isNotEmpty', function (list, context) {
      return list != undefined && Array.isArray(list) && list.length > 0;
    });
  },
  _getPartial: function (record) {
    var name = this.cmpId + '_default';
    for (let key in record) {
      var partialName = this.__getPartianName(key, record[key]);
      if (partialName) {
        name = partialName;
        break;
      }
    }
    return name;
  },
  __getPartianName: function (key, value) {
    var partial;
    $.each(this.partialRules, function (index, rule) {
      if (rule.header === key && rule.match === value) {
        partial = rule.partialName;
        return false;
      }
    });
    return partial;
  },
  _reset: function (obj) {
    if ((this.formId && this.formId != obj.elmId) || !this.formId) {
      return;
    }
    this._hideTheResutls();
    $.observer.publish(DataLookupResults.Events.RESET_INITIALIZED);
  },
  _search: function (obj) {
    if ((this.formId && this.formId != obj.elmId) || !this.formId) {
      return;
    }
    this._hideTheResutls();
    $.observer.publish(DataLookupResults.Events.SEARCH_INITIALIZED);

    var $widget = this;
    $.ajax({
      url: this._getLocation(),
      data: {
        query: JSON.stringify(this._prepareQuerydata(obj.data)),
      },
      dataType: 'json',
      type: 'GET',
      success: function (response) {
        if (response.results && response.results.length > 0) {
          $widget._showTheResutls(response);
        } else {
          $widget._showNotFound();
        }
        $.observer.publish(DataLookupResults.Events.SEARCH_SUCCESS);
      },
      error: function (response) {
        $.observer.publish(DataLookupResults.Events.SEARCH_ERROR);
        $widget._showError();
      },
    });
  },
  _showForm: function () {
    if (this.hideForm) {
      $('#' + this.formId)
        .trigger('reset')
        .closest('.cmp-form-container')
        .removeClass('hidden-publish-view');
      this.element
        .find('.cmp-datalookupresults-goback')
        .addClass('hidden-publish-view');
      $.observer.publish(DataLookupResults.Events.FORM_SHOWN);
    }
  },
  _hideForm: function () {
    if (this.hideForm) {
      $('#' + this.formId)
        .closest('.cmp-form-container')
        .addClass('hidden-publish-view');
      this.element
        .find('.cmp-datalookupresults-goback')
        .removeClass('hidden-publish-view');
      $.observer.publish(DataLookupResults.Events.FORM_HIDEN);
    }
  },
  _hideTheResutls: function () {
    this._showForm();
    this.element
      .find('.cmp-datalookupresults_results-util-container')
      .addClass('hidden-publish-view');
    this.element
      .find('.cmp-datalookupresults_results_set-items')
      .addClass('hidden-publish-view');
    this.element.addClass('hidden-publish-view');
    $.observer.publish(DataLookupResults.Events.RESULTS_HIDDEN);
  },
  _showTheResutls: function (response) {
    this._hideForm();
    this.element
      .find('.cmp-datalookupresults_results_set-items')
      .html(this.tmpScript(response));
    this.element
      .find('.cmp-datalookupresults_results-util-container')
      .removeClass('hidden-publish-view');
    this.element
      .find('.cmp-datalookupresults_results_set-items')
      .removeClass('hidden-publish-view');
    if (this.animate) {
      this.element.hide();
      this.element.removeClass('hidden-publish-view');
      this.element.slideDown();
    } else {
      this.element.removeClass('hidden-publish-view');
    }
    this._scroll();
    $.observer.publish(DataLookupResults.Events.RESULTS_SHOWN);
  },
  _scroll: function () {
    if (this.scroll) {
      $('html,body').animate({ scrollTop: this.element.offset().top }, 'slow');
    }
  },
  _showNotFound: function () {
    this._hideForm();
    this.element
      .find('.cmp-datalookupresults_results_set-items')
      .html(Handlebars.partials[this.cmpId + '_nrf']({ results: [] }));
    this.element
      .find('.cmp-datalookupresults_results-util-container')
      .addClass('hidden-publish-view');
    this.element
      .find('.cmp-datalookupresults_results_set-items')
      .removeClass('hidden-publish-view');
    this.element.removeClass('hidden-publish-view');
    this._scroll();
    $.observer.publish(DataLookupResults.Events.RESULTS_NOTFOUND);
  },
  _showError: function () {
    this._hideForm();
    this.element
      .find('.cmp-datalookupresults_results_set-items')
      .html(Handlebars.partials[this.cmpId + '_error']({ error: true }));
    this.element
      .find('.cmp-datalookupresults_results-util-container')
      .addClass('hidden-publish-view');
    this.element
      .find('.cmp-datalookupresults_results_set-items')
      .removeClass('hidden-publish-view');
    this.element.removeClass('hidden-publish-view');
    this._scroll();
    $.observer.publish(DataLookupResults.Events.RESULTS_NOTFOUND);
  },
  _getLocation: function () {
    return window.location.pathname.replace(
      /\.(html)($|\?)/,
      '.data.search.' + this.cmpId + '.json$2'
    );
  },
  _prepareQuerydata: function (data) {
    var tmpData = [];
    if (data) {
      for (var key in data) {
        if (data[key] && data[key] != '') {
          tmpData.push({
            key: key,
            value: typeof data[key] === 'string' ? data[key] : undefined,
            values: Array.isArray(data[key]) ? data[key] : undefined,
          });
        }
      }
    }
    return tmpData;
  },
});

(function ($) {
  $('.cmp-datalookupresults').datalookupresults();
})(jQuery);

$.widget('gene.formbutton', {
  _create: function () {
    this.$form = this.element.closest('form');
    this.$reset = this.element.data('reset');
  },
  _init: function () {
    if (this.$reset == true) {
      this.element.bind('click', $.proxy(this._reset, this));
    }
  },
  _reset: function (evt) {
    evt.preventDefault();
    $(this.$form).trigger('reset');
  },
});

(function ($) {
  $('.cmp-form-button').formbutton();
})(jQuery);
